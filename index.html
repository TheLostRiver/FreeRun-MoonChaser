<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<title>Free Run: Moon Chaser</title>
	<style>
		@import url('https://fonts.googleapis.com/css2?family=Titan+One&display=swap');
		@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@900&display=swap');

		body {
			margin: 0;
			overflow: hidden;
			background-color: #050520;
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			user-select: none;
			-webkit-user-select: none;
		}

		#gameCanvas {
			display: block;
			width: 100vw;
			height: 100vh;
		}

		#ui-layer {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			pointer-events: none;
		}

		/* --- Settings UI --- */
		.setting-row {
			display: flex;
			align-items: center;
			justify-content: space-between;
			width: 100%;
			margin-bottom: 25px;
			color: white;
			font-family: 'Titan One', sans-serif;
		}

		.setting-label {
			width: 120px;
			text-align: left;
			color: #00FFFF;
			font-size: 18px;
		}

		.setting-val {
			width: 50px;
			text-align: right;
			font-family: monospace;
			font-weight: bold;
			color: #FFD700;
		}

		/* è‡ªå®šä¹‰æ»‘å—è½¨é“ */
		.volume-slider {
			-webkit-appearance: none;
			width: 100%;
			height: 10px;
			border-radius: 5px;
			background: #333;
			outline: none;
			border: 1px solid #555;
		}

		/* æ»‘å—æ‹–åŠ¨å¤´ (Thumb) */
		.volume-slider::-webkit-slider-thumb {
			-webkit-appearance: none;
			appearance: none;
			width: 24px;
			height: 24px;
			border-radius: 50%;
			background: #00FFFF;
			cursor: pointer;
			box-shadow: 0 0 10px #00FFFF;
			margin-top: -8px;
			/* å±…ä¸­ */
		}

		/* Chrome/Safari è½¨é“ */
		.volume-slider::-webkit-slider-runnable-track {
			width: 100%;
			height: 8px;
			cursor: pointer;
			background: #2c3e50;
			border-radius: 5px;
		}

		.btn-3d {
			pointer-events: auto;
			border: none;
			outline: none;
			cursor: pointer;
			font-family: 'Titan One', 'Noto Sans SC', sans-serif;
			text-transform: uppercase;
			transition: transform 0.1s;
		}

		.btn-3d:active {
			transform: translateY(4px);
			box-shadow: 0 0px 0 rgba(0, 0, 0, 0.2) !important;
		}

		/* é¡¶éƒ¨æŒ‰é’®ç»„ */
		.top-btn {
			position: absolute;
			top: 20px;
			background: rgba(0, 0, 0, 0.6);
			color: white;
			border: 2px solid rgba(255, 255, 255, 0.5);
			padding: 8px 16px;
			border-radius: 20px;
			font-weight: bold;
			font-size: 14px;
			z-index: 500;
			cursor: pointer;
			pointer-events: auto;
		}

		#lang-btn {
			left: 20px;
		}

		#sound-btn {
			left: 120px;
			width: 40px;
			text-align: center;
			padding: 8px 0;
		}

		/* è®¾ç½®æŒ‰é’® (æ”¾åœ¨ä¸­é—´) */
		#setting-btn {
			left: 180px;
			/* ä» 170 æ”¹åˆ° 180ï¼Œç•™å‡ºé—´éš™ */
			width: 40px;
			text-align: center;
			padding: 8px 0;
		}

		#pause-btn {
			position: absolute;
			top: 20px;
			left: 240px;
			background: rgba(230, 126, 34, 0.8);
			color: white;
			border: 2px solid rgba(255, 255, 255, 0.5);
			width: 40px;
			height: 40px;
			border-radius: 50%;
			font-weight: bold;
			font-size: 18px;
			line-height: 36px;
			text-align: center;
			z-index: 500;
			cursor: pointer;
			pointer-events: auto;
			box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
			font-family: 'Segoe UI', sans-serif !important;
			/* å¼ºåˆ¶ä½¿ç”¨ç³»ç»Ÿå­—ä½“ï¼Œé˜²æ­¢è‰ºæœ¯å­—ä½“ææ€ª */
			font-size: 24px;
			/* ç¨å¾®å¤§ä¸€ç‚¹ */
			padding-top: 2px;
			/* å¾®è°ƒå‚ç›´å±…ä¸­ */
			line-height: 38px;
		}

		#pause-btn:hover {
			background: #d35400;
		}

		/* HUD */
		#hud-panel {
			position: absolute;
			top: 20px;
			right: 20px;
			display: flex;
			flex-direction: column;
			align-items: flex-end;
			transition: opacity 0.3s;
			/* ğŸ”¥ğŸ”¥ğŸ”¥ æ–°å¢è¿™è¡Œï¼šç¡®ä¿å®ƒåœ¨æœ€ä¸Šå±‚ ğŸ”¥ğŸ”¥ğŸ”¥ */
			z-index: 1000;
		}

		#score-display {
			font-family: 'Titan One', 'Noto Sans SC', cursive;
			font-size: 36px;
			color: white;
			text-shadow: 3px 3px 0 #000;
			margin-bottom: 5px;
		}

		.coin-container {
			display: flex;
			align-items: center;
			background: rgba(0, 0, 0, 0.5);
			padding: 5px 12px;
			border-radius: 15px;
			border: 1px solid rgba(255, 255, 255, 0.2);
			margin-bottom: 5px;
		}

		.css-coin {
			width: 20px;
			height: 20px;
			background: linear-gradient(135deg, #ffd700, #ffaa00);
			border: 2px solid #fff;
			border-radius: 50%;
			margin-right: 8px;
			box-shadow: 0 0 5px rgba(255, 215, 0, 0.6);
		}

		#coin-display {
			font-size: 20px;
			font-weight: bold;
			color: #FFD700;
			text-shadow: 1px 1px 0 #000;
		}

		#coin-multiplier {
			font-size: 16px;
			font-weight: 900;
			font-family: monospace;
			color: #00FFFF;
			margin-left: 8px;
			font-style: italic;
			text-shadow: 0 0 5px rgba(0, 255, 255, 0.8);
		}

		#speed-indicator {
			font-family: 'Titan One', monospace;
			color: #00FFFF;
			font-size: 18px;
			text-shadow: 1px 1px 0 #000;
			margin-bottom: 10px;
			font-style: italic;
		}

		#status-bars {
			display: flex;
			flex-direction: column;
			gap: 5px;
			margin-top: 5px;
			align-items: flex-end;
		}

		.status-bar {
			display: flex;
			align-items: center;
			padding: 5px 15px;
			border-radius: 20px;
			border: 2px solid #fff;
			transform: scale(0);
			transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
			transform-origin: right center;
			margin-bottom: 5px;
		}

		.status-bar.active {
			transform: scale(1);
		}

		.status-icon {
			font-size: 20px;
			margin-right: 8px;
		}

		.status-timer {
			color: white;
			font-weight: 900;
			font-family: monospace;
			font-size: 18px;
		}

		/* æ–°å¢ï¼šæŠ¤ç›¾çš„èƒŒæ™¯æ¸å˜ (é’è“è‰²ï¼ŒåŒºåˆ«äºå–·æ°”èƒŒåŒ…çš„æ·±è“) */
		#shield-status {
			background: linear-gradient(90deg, #1abc9c, #16a085);
			/* é»˜è®¤éšè—ï¼Œé€šè¿‡æ·»åŠ  .active ç±»æ˜¾ç¤º */
			display: flex;
			opacity: 0;
			transition: opacity 0.3s;
		}

		/* å½“æŠ¤ç›¾å¤„äºæ¿€æ´»çŠ¶æ€ (æœ‰ç›¾ æˆ– æ— æ•Œä¸­) æ—¶æ˜¾ç¤º */
		#shield-status.active {
			opacity: 1;
			transform: scale(1);
		}

		/* æ— æ•Œæ—¶é—´çš„é—ªçƒåŠ¨ç”» */
		@keyframes shieldBlink {
			0% {
				opacity: 1;
			}

			50% {
				opacity: 0.5;
			}

			100% {
				opacity: 1;
			}
		}

		.shield-flicker {
			animation: shieldBlink 0.2s infinite;
		}

		#jetpack-status {
			background: linear-gradient(90deg, #3498db, #2980b9);
		}

		#magnet-status {
			background: linear-gradient(90deg, #e74c3c, #c0392b);
		}

		.menu-screen {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(25, 25, 112, 0.4);
			backdrop-filter: blur(4px);
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			pointer-events: auto;
			transition: opacity 0.3s;
			z-index: 150;
			cursor: default;
		}

		.hidden {
			display: none !important;
		}

		.game-title {
			font-family: 'Titan One', 'Noto Sans SC', sans-serif;
			font-weight: 900;
			font-size: 60px;
			line-height: 1.2;
			text-align: center;
			color: #FFD700;
			text-shadow: 2px 2px 0 #000, 0 5px 0 #d35400, 0 8px 10px rgba(0, 0, 0, 0.5);
			transform: skewY(-3deg);
			margin-bottom: 40px;
			animation: floatTitle 3s ease-in-out infinite;
		}

		@keyframes floatTitle {

			0%,
			100% {
				transform: skewY(-3deg) translateY(0);
			}

			50% {
				transform: skewY(-3deg) translateY(-10px);
			}
		}

		.menu-content {
			display: flex;
			flex-direction: column;
			align-items: center;
			z-index: 160;
		}

		.play-btn-style {
			background-color: #2ecc71;
			color: white;
			font-size: 28px;
			padding: 15px 60px;
			border-radius: 50px;
			box-shadow: 0 6px 0 #219150;
			margin-bottom: 20px;
		}

		.store-btn-style {
			background-color: #9b59b6;
			color: white;
			font-size: 18px;
			padding: 10px 40px;
			border-radius: 30px;
			box-shadow: 0 5px 0 #8e44ad;
			margin-bottom: 10px;
		}

		/* è§’è‰²æŒ‰é’®æ ·å¼ */
		.char-btn-style {
			background-color: #e67e22;
			color: white;
			font-size: 18px;
			padding: 10px 40px;
			border-radius: 30px;
			box-shadow: 0 5px 0 #d35400;
			margin-bottom: 10px;
		}

		.rank-btn-style {
			background-color: #f39c12;
			color: white;
			font-size: 18px;
			padding: 10px 40px;
			border-radius: 30px;
			box-shadow: 0 5px 0 #d35400;
			margin-bottom: 20px;
		}

		.retry-btn-style {
			background-color: #e74c3c;
			color: white;
			font-size: 24px;
			padding: 12px 40px;
			border-radius: 50px;
			box-shadow: 0 6px 0 #c0392b;
		}

		.home-btn-style {
			margin-top: 15px;
			background: #3498db;
			padding: 10px 20px;
			font-size: 16px;
			border-radius: 20px;
			color: white;
			box-shadow: 0 4px 0 #2980b9;
		}

		#pause-screen {
			z-index: 400;
			background: rgba(0, 0, 0, 0.6);
		}

		.pause-container {
			background: rgba(20, 20, 50, 0.9);
			padding: 40px 60px;
			border-radius: 20px;
			border: 3px solid #00FFFF;
			box-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
			text-align: center;
			display: flex;
			flex-direction: column;
			gap: 20px;
		}

		.pause-title {
			font-family: 'Titan One', 'Noto Sans SC';
			font-size: 48px;
			color: white;
			text-shadow: 0 0 10px #00FFFF;
			margin-bottom: 10px;
		}

		.resume-btn-style {
			background-color: #2ecc71;
			color: white;
			font-size: 24px;
			padding: 10px 40px;
			border-radius: 30px;
			box-shadow: 0 5px 0 #27ae60;
		}

		/* Generic Modal (Store & Characters) */
		#store-screen,
		#char-screen {
			z-index: 250;
		}

		.store-container {
			background: rgba(10, 10, 40, 0.95);
			padding: 25px;
			border-radius: 20px;
			border: 2px solid #00FFFF;
			box-shadow: 0 0 30px rgba(0, 255, 255, 0.2);
			width: 90%;
			max-width: 600px;
			max-height: 85vh;
			overflow-y: auto;
			display: flex;
			flex-direction: column;
			align-items: center;
		}

		.store-header {
			width: 100%;
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 20px;
			border-bottom: 1px solid rgba(255, 255, 255, 0.2);
			padding-bottom: 10px;
			flex-shrink: 0;
		}

		.store-balance {
			display: flex;
			align-items: center;
			font-size: 24px;
			color: #FFD700;
			font-weight: bold;
		}

		.store-grid {
			display: flex;
			gap: 20px;
			justify-content: center;
			flex-wrap: wrap;
			width: 100%;
			padding-bottom: 20px;
		}

		.store-item {
			background: rgba(255, 255, 255, 0.05);
			width: 220px;
			border-radius: 15px;
			padding: 15px;
			display: flex;
			flex-direction: column;
			align-items: center;
			border: 1px solid rgba(255, 255, 255, 0.1);
			transition: transform 0.2s;
		}

		.store-item:hover {
			transform: translateY(-5px);
			border-color: #00FFFF;
		}

		.item-icon {
			font-size: 40px;
			margin-bottom: 10px;
		}

		.item-name {
			color: white;
			font-weight: bold;
			font-size: 18px;
			margin-bottom: 5px;
		}

		.item-desc {
			color: #aaa;
			font-size: 12px;
			text-align: center;
			margin-bottom: 15px;
			height: 30px;
		}

		.buy-btn {
			background: #27ae60;
			color: white;
			border: none;
			padding: 8px 20px;
			border-radius: 20px;
			font-weight: bold;
			cursor: pointer;
			display: flex;
			align-items: center;
			gap: 5px;
			margin-bottom: 10px;
			box-shadow: 0 4px 0 #219150;
		}

		.buy-btn:active {
			transform: translateY(2px);
			box-shadow: 0 2px 0 #219150;
		}

		.buy-btn:disabled {
			background: #555;
			box-shadow: none;
			cursor: not-allowed;
			opacity: 0.6;
		}

		/* è§’è‰²æŒ‰é’®ç‰¹å®šæ ·å¼ */
		.buy-btn.equipped {
			background: #555;
			cursor: default;
			box-shadow: none;
		}

		.buy-btn.select {
			background: #e67e22;
			box-shadow: 0 4px 0 #d35400;
		}

		.item-owned {
			color: #00FFFF;
			font-size: 14px;
			margin-bottom: 8px;
			font-weight: bold;
		}

		.toggle-container {
			display: flex;
			align-items: center;
			gap: 10px;
			color: white;
			font-size: 14px;
		}

		.switch {
			position: relative;
			display: inline-block;
			width: 40px;
			height: 20px;
		}

		.switch input {
			opacity: 0;
			width: 0;
			height: 0;
		}

		.slider {
			position: absolute;
			cursor: pointer;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background-color: #ccc;
			transition: .4s;
			border-radius: 20px;
		}

		.slider:before {
			position: absolute;
			content: "";
			height: 16px;
			width: 16px;
			left: 2px;
			bottom: 2px;
			background-color: white;
			transition: .4s;
			border-radius: 50%;
		}

		input:checked+.slider {
			background-color: #00FFFF;
		}

		input:checked+.slider:before {
			transform: translateX(20px);
		}

		#main-menu-coins {
			position: absolute;
			top: 20px;
			right: 20px;
			font-size: 24px;
			color: #FFD700;
			font-weight: bold;
			text-shadow: 2px 2px 0 #000;
			display: flex;
			align-items: center;
			gap: 5px;
		}

		#controls-hint {
			margin-top: 30px;
			background: rgba(10, 10, 30, 0.85);
			padding: 20px 30px;
			border-radius: 20px;
			border: 2px solid rgba(0, 255, 255, 0.3);
			display: flex;
			flex-direction: column;
			gap: 15px;
			align-items: center;
			pointer-events: none;
			box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
			backdrop-filter: blur(5px);
		}

		.control-row {
			display: flex;
			align-items: center;
			gap: 15px;
			color: #fff;
			font-weight: bold;
			font-size: 14px;
			font-family: 'Titan One', sans-serif;
			text-shadow: 1px 1px 2px black;
		}

		.key-cap {
			display: inline-block;
			min-width: 32px;
			height: 32px;
			background: #222;
			color: #eee;
			font-family: 'Segoe UI', sans-serif;
			font-weight: 900;
			line-height: 30px;
			text-align: center;
			padding: 0 8px;
			border-radius: 6px;
			border-bottom: 4px solid #000;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
			transform: translateY(0);
		}

		.key-move {
			border-bottom-color: #008B8B;
			color: #00FFFF;
		}

		.key-jump {
			border-bottom-color: #B8860B;
			color: #FFD700;
		}

		.key-roll {
			border-bottom-color: #8B008B;
			color: #FF00FF;
		}

		.control-label {
			color: #ddd;
			font-size: 12px;
			letter-spacing: 1px;
			text-transform: uppercase;
		}

		.swipe-hint {
			display: flex;
			align-items: center;
			gap: 8px;
			color: #aaa;
			font-size: 12px;
			font-style: italic;
			margin-top: 5px;
		}

		.swipe-icon {
			font-size: 16px;
		}

		#leaderboard-screen {
			z-index: 200;
		}

		.leaderboard-container {
			background: rgba(0, 0, 0, 0.9);
			padding: 20px;
			border-radius: 25px;
			border: 3px solid #FFD700;
			width: 90%;
			max-width: 450px;
			max-height: 70vh;
			overflow-y: auto;
		}

		.lb-table {
			width: 100%;
			border-collapse: collapse;
			color: white;
			font-family: sans-serif;
		}

		.lb-table th {
			color: #FFD700;
			padding: 10px;
			border-bottom: 2px solid #555;
			cursor: pointer;
		}

		.lb-table td {
			padding: 8px;
			text-align: center;
			border-bottom: 1px solid #333;
		}

		.lb-close-btn {
			margin-top: 25px;
			background: #e74c3c;
			font-size: 20px;
			padding: 10px 40px;
			border-radius: 30px;
			box-shadow: 0 5px 0 #c0392b;
			flex-shrink: 0;
		}

		.sort-icon {
			font-size: 14px;
			margin-left: 8px;
			opacity: 0.8;
			color: #FFD700;
		}

		#name-input {
			font-size: 20px;
			padding: 10px;
			border-radius: 10px;
			text-align: center;
			margin-bottom: 15px;
		}

		#loading {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			color: white;
			font-weight: bold;
		}

		#game-over {
			z-index: 300;
		}

		/* --- å®šä¹‰ PC ç«¯å¼¹å‡ºåŠ¨ç”» --- */
		@keyframes popInPC {
			0% {
				opacity: 0;
				/* å¼€å§‹ï¼šé€æ˜ï¼Œç¼©æ”¾0.5å€ */
				transform: translate(-50%, -50%) scale(0.5);
			}

			80% {
				/* ä¸­é—´ï¼šç¨å¾®æ”¾å¤§ä¸€ç‚¹ç‚¹ï¼Œåˆ¶é€ å›å¼¹æ„Ÿ */
				transform: translate(-50%, -50%) scale(1.05);
			}

			100% {
				opacity: 1;
				/* ç»“æŸï¼šæ¢å¤æ­£å¸¸ */
				transform: translate(-50%, -50%) scale(1);
			}
		}

		/* --- å®šä¹‰ ç§»åŠ¨ç«¯ å¼¹å‡ºåŠ¨ç”» (åªæ§åˆ¶Yè½´) --- */
		@keyframes popInMobile {
			0% {
				opacity: 0;
				transform: translateY(-50%) scale(0.5);
			}

			80% {
				transform: translateY(-50%) scale(1.05);
			}

			100% {
				opacity: 1;
				transform: translateY(-50%) scale(1);
			}
		}

		/* =========================================
		æ–°ç‰ˆç»“ç®—ç•Œé¢æ ·å¼ (Game Over UI)
		========================================= */
		#game-over-screen {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);

			/* é…·ç‚«çš„æ·±è‰²ç»ç’ƒæ‹Ÿæ€èƒŒæ™¯ */
			background: linear-gradient(135deg, rgba(20, 20, 50, 0.95), rgba(10, 10, 30, 0.98));
			border: 2px solid #FFD700;
			/* é‡‘è‰²è¾¹æ¡† */
			box-shadow: 0 0 30px rgba(255, 215, 0, 0.3), inset 0 0 20px rgba(0, 0, 0, 0.5);
			border-radius: 20px;

			width: 400px;
			/* PCé»˜è®¤å®½åº¦ */
			padding: 30px;
			z-index: 2000;
			/* ä¿è¯åœ¨æœ€ä¸Šå±‚ */
			text-align: center;
			color: white;
			font-family: "Arial", sans-serif;

			/* ğŸ”¥ğŸ”¥ğŸ”¥ æ–°å¢ï¼šå¼•ç”¨ä¸Šé¢çš„åŠ¨ç”» ğŸ”¥ğŸ”¥ğŸ”¥ */
			/* cubic-bezier å¸¦æ¥Qå¼¹çš„æ•ˆæœ */
			animation: popInPC 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;

			/* ğŸ”¥ğŸ”¥ğŸ”¥ å¿…é¡»åŠ ä¸Šè¿™ä¸€è¡Œï¼ğŸ”¥ğŸ”¥ğŸ”¥ */
			pointer-events: auto !important;
		}

		/* æ ‡é¢˜ç‰¹æ•ˆ */
		.go-title {
			font-size: 36px;
			margin: 0 0 25px 0;
			color: #FF4444;
			/* çº¢è‰²è­¦å‘Šè‰² */
			text-shadow: 2px 2px 0px #500000;
			letter-spacing: 2px;
			font-weight: 900;
			text-transform: uppercase;
		}

		/* æ•°æ®è¡Œå¸ƒå±€ */
		.go-row {
			display: flex;
			justify-content: space-between;
			/* å·¦å³å¯¹é½ */
			align-items: center;
			margin-bottom: 12px;
			font-size: 18px;
		}

		.go-label {
			color: #aaaaaa;
			/* æ ‡ç­¾ç°è‰² */
			font-size: 14px;
			font-weight: bold;
		}

		.go-value {
			color: #ffffff;
			font-size: 20px;
			font-weight: bold;
			font-family: monospace;
			/* ç­‰å®½å­—ä½“æ•°å­—æ›´å¥½çœ‹ */
		}

		/* åˆ†å‰²çº¿ */
		.go-divider {
			height: 1px;
			background: rgba(255, 255, 255, 0.2);
			margin: 15px 0;
		}

		/* æœ€ä½³çºªå½•é«˜äº® */
		.go-row.highlight .go-value {
			color: #FFD700;
			/* é‡‘è‰² */
			text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
		}

		/* æŒ‰é’®ç»„ */
		.go-btn-group {
			display: flex;
			gap: 15px;
			/* æŒ‰é’®é—´è· */
			margin-top: 25px;
		}

		.go-btn-group button {
			flex: 1;
			/* ä¸¤ä¸ªæŒ‰é’®å¹³åˆ†å®½åº¦ */
			padding: 12px 0;
			border: none;
			border-radius: 50px;
			font-size: 16px;
			font-weight: bold;
			cursor: pointer;
			color: white;
			transition: transform 0.1s;
			box-shadow: 0 4px 0 rgba(0, 0, 0, 0.3);
		}

		/* ç»¿è‰²é‡æ¥æŒ‰é’® */
		#go-restart-btn {
			background: linear-gradient(to bottom, #2ecc71, #27ae60);
			box-shadow: 0 4px 0 #1e8449;
		}

		/* è“è‰²èœå•æŒ‰é’® */
		#go-menu-btn {
			background: linear-gradient(to bottom, #3498db, #2980b9);
			box-shadow: 0 4px 0 #1f618d;
		}

		.go-btn-group button:active {
			transform: translateY(4px);
			box-shadow: none !important;
		}

		/* è¾“å…¥æ¡†å®¹å™¨ */
		.go-input-container {
			margin-top: 15px;
			margin-bottom: 5px;
		}

		/* é…·ç‚«çš„è¾“å…¥æ¡†æ ·å¼ */
		.go-input {
			background: rgba(0, 0, 0, 0.3);
			border: 2px solid rgba(255, 255, 255, 0.2);
			border-radius: 10px;
			padding: 10px;
			color: #00FFFF;
			font-family: 'Titan One', sans-serif;
			/* ä¿æŒå­—ä½“é£æ ¼ */
			font-size: 18px;
			text-align: center;
			width: 60%;
			outline: none;
			transition: border-color 0.3s;
		}

		.go-input:focus {
			border-color: #00FFFF;
			box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
		}

		/* =========================================
		ç§»åŠ¨ç«¯é€‚é… V9 (ä¿®å¤æ’è¡Œæ¦œæº¢å‡º - é’‰æ­»ç‰ˆ)
		æ ¸å¿ƒåŸç†ï¼šå·¦å³è·ç¦»é’‰æ­»ï¼Œå¼ºåˆ¶æ¸…é›¶ min-width
		========================================= */
		@media only screen and (max-width: 768px) {

			/* --- 1. åŸºç¡€UIé€‚é… (ä¿æŒå®Œç¾) --- */
			.game-title {
				font-size: 32px !important;
				margin-top: 90px !important;
				margin-bottom: 25px !important;
				width: 100% !important;
			}

			.play-btn-style,
			.store-btn-style,
			.char-btn-style,
			.rank-btn-style {
				box-sizing: border-box !important;
				width: 220px !important;
				min-width: 220px !important;
				max-width: none !important;
				height: auto !important;
				padding: 12px 0 !important;
				border-radius: 50px !important;
				font-size: 16px !important;
				font-weight: bold !important;
				line-height: normal !important;
				white-space: nowrap !important;
				position: relative !important;
				display: block !important;
				margin: 0 auto 12px auto !important;
				left: auto !important;
				transform: none !important;
				flex: none !important;
			}

			.play-btn-style {
				width: 240px !important;
				min-width: 240px !important;
				font-size: 20px !important;
				padding: 15px 0 !important;
				margin-bottom: 20px !important;
				box-shadow: 0 5px 0 #006400 !important;
			}

			.top-btn {
				top: 15px !important;
				transform: scale(0.9) !important;
				transform-origin: top left !important;
			}

			#lang-btn {
				left: 15px !important;
			}

			#sound-btn {
				left: 105px !important;
			}

			/* 3. è®¾ç½® (æ”¶ç´§) */
			#setting-btn {
				left: 155px !important;
			}

			/* 4. æš‚åœ (æ”¶ç´§) */
			#pause-btn {
				left: 205px !important;
				transform: scale(0.9);
				/* æš‚åœæŒ‰é’®ä¹Ÿç¨å¾®ç¼©å°ä¸€ç‚¹ */
				top: 15px;
			}

			#controls-hint {
				width: 90% !important;
				bottom: 20px !important;
				padding: 8px !important;
				background: rgba(0, 0, 0, 0.5) !important;
			}

			#controls-hint .control-row {
				display: none !important;
			}

			.swipe-hint {
				font-size: 14px !important;
				margin: 0 !important;
			}

			#hud-panel {
				top: 5px !important;
				right: 5px !important;
				transform: scale(0.7);
				transform-origin: top right;
				/* ğŸ”¥ å…³é”®ï¼šç¡®ä¿å®ƒæ˜¯è´´ç€å³ä¸Šè§’ç¼©æ”¾çš„ï¼Œä¸ä¼šè·‘å */
			}

			/* --- 2. æ ¸å¿ƒä¿®å¤ï¼šæ’è¡Œæ¦œ/å¼¹çª— (é‡‡ç”¨å·¦å³é’‰æ­»ç­–ç•¥) --- */

			#rankings-overlay,
			#store-overlay,
			#char-overlay,
			#game-over-screen {
				/* A. å…³é”®å±æ€§ï¼šå¼ºåˆ¶å®šä½æ–¹å¼ */
				position: fixed !important;
				/* å¿…é¡»æ˜¯ fixedï¼Œé˜²æ­¢éšé¡µé¢æ»šåŠ¨ */

				/* B. å…³é”®å±æ€§ï¼šå·¦å³é’‰æ­» */
				/* æ—¢ç„¶å±…ä¸­ç®—ä¸å¯¹ï¼Œæˆ‘ä»¬å°±å¼ºåˆ¶å®ƒè·ç¦»å·¦å³å„ 15px */
				/* è¿™æ ·å®½åº¦ä¼šè¢«ç‰©ç†é™åˆ¶åœ¨å±å¹•ä¸­é—´ */
				left: 15px !important;
				right: 15px !important;
				width: auto !important;
				/* è®©å®½åº¦è‡ªåŠ¨å¡«æ»¡å·¦å³çš„ç©ºéš™ */

				/* C. å‚ç›´å±…ä¸­ä¿æŒä¸å˜ */
				top: 50% !important;
				transform: translateY(-50%) !important;
				/* åªåšå‚ç›´åç§» */

				/* ğŸ”¥ğŸ”¥ğŸ”¥ æ–°å¢ï¼šè¦†ç›–ä¸ºç§»åŠ¨ç«¯åŠ¨ç”» ğŸ”¥ğŸ”¥ğŸ”¥ */
				animation: popInMobile 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards !important;

				/* D. å½»åº•æ¸…é™¤â€œæœ€å°å®½åº¦â€æ¯’ç˜¤ */
				min-width: 0 !important;
				/* è¿™è¡Œä»£ç ä»·å€¼åƒé‡‘ï¼Œæ€æ‰ PC ç«¯çš„ min-width */
				max-width: none !important;

				box-sizing: border-box !important;
				padding: 15px 5px !important;
				/* å‡å°å†…è¾¹è· */
				overflow: hidden !important;
			}

			/* E. è¡¨æ ¼å¼ºåˆ¶é€‚é… */
			#rankings-overlay table {
				width: 100% !important;
				min-width: 0 !important;
				/* è¡¨æ ¼è‡ªå·±ä¹Ÿä¸è®¸æœ‰æœ€å°å®½åº¦ */
				table-layout: fixed !important;
				margin-bottom: 10px !important;
			}

			#rankings-overlay th,
			#rankings-overlay td {
				font-size: 11px !important;
				/* å­—å·å†å°ä¸€ç‚¹ï¼Œä¿å¹³å®‰ */
				padding: 4px 1px !important;
				/* æé™å‹ç¼©é—´è· */
				text-align: center !important;
				white-space: nowrap !important;
				overflow: hidden !important;
				text-overflow: ellipsis !important;
			}

			/* è°ƒæ•´åˆ—å®½æ¯”ä¾‹ */
			#rankings-overlay th:nth-child(1),
			#rankings-overlay td:nth-child(1) {
				width: 12% !important;
			}

			#rankings-overlay th:nth-child(2),
			#rankings-overlay td:nth-child(2) {
				width: 38% !important;
			}

			#rankings-overlay th:nth-child(3),
			#rankings-overlay td:nth-child(3) {
				width: 25% !important;
			}

			#rankings-overlay th:nth-child(4),
			#rankings-overlay td:nth-child(4) {
				width: 25% !important;
			}

			#rankings-overlay h2 {
				font-size: 20px !important;
				margin-top: 5px !important;
				white-space: nowrap !important;
				/* é˜²æ­¢æ ‡é¢˜æ¢è¡Œæ’‘å¼€ */
			}

			/* å¤ç”¨ V9 çš„å·¦å³é’‰æ­»ç­–ç•¥ */
			#game-over-screen {
				position: fixed !important;
				left: 20px !important;
				right: 20px !important;
				width: auto !important;
				/* è‡ªåŠ¨å¡«æ»¡ */
				min-width: 0 !important;
				max-width: none !important;

				top: 50% !important;
				transform: translateY(-50%) !important;

				padding: 20px !important;
				box-sizing: border-box !important;
			}

			.go-title {
				font-size: 28px !important;
				/* æ ‡é¢˜ç¼©å° */
				margin-bottom: 20px !important;
			}

			.go-row {
				margin-bottom: 8px !important;
			}

			.go-label {
				font-size: 12px !important;
			}

			.go-value {
				font-size: 16px !important;
			}

			/* æŒ‰é’®åœ¨æ‰‹æœºä¸Šä¿æŒå¹¶æ’ï¼Œä½†ç¨å¾®é«˜ä¸€ç‚¹ */
			.go-btn-group button {
				padding: 12px 0 !important;
				font-size: 14px !important;
			}

			.go-input {
				width: 80% !important;
				font-size: 16px !important;
				padding: 8px !important;
			}
		}
	</style>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>

<body>

	<div id="loading">Loading Engine...</div>
	<div id="game-container"></div>

	<div id="ui-layer">
		<button id="setting-btn" class="btn-3d top-btn" onclick="openSettings(event)"
			style="left: 170px;">âš™ï¸</button>
		<button id="lang-btn" class="btn-3d top-btn">CN / EN</button>
		<button id="sound-btn" class="btn-3d top-btn" onclick="AudioSys.toggle()">ğŸ”Š</button>
		<div id="pause-btn" class="hidden" onclick="togglePause(event)">â¸</div>

		<div id="settings-screen" class="menu-screen hidden" style="z-index: 600;">
			<div class="store-container" style="max-width: 400px;">
				<div class="store-header">
					<div class="game-title"
						style="font-size:28px; margin:0; animation:none; transform:none;">AUDIO
						SETTINGS</div>
				</div>

				<div style="width: 100%; padding: 20px 0;">
					<div class="setting-row">
						<span class="setting-label">MUSIC (BGM)</span>
						<input type="range" id="bgm-slider" class="volume-slider" min="0"
							max="1" step="0.1" value="0.5"
							oninput="AudioSys.setBGMVol(this.value)">
						<span id="bgm-val" class="setting-val">50%</span>
					</div>

					<div class="setting-row">
						<span class="setting-label">SOUND (SFX)</span>
						<input type="range" id="sfx-slider" class="volume-slider" min="0"
							max="1" step="0.1" value="0.3"
							oninput="AudioSys.setSFXVol(this.value)">
						<span id="sfx-val" class="setting-val">30%</span>
					</div>
				</div>

				<button class="btn-3d lb-close-btn" onclick="closeSettings(event)">CLOSE</button>
			</div>
		</div>

		<div id="hud-panel" class="hidden">
			<div id="score-display">000000</div>
			<div id="speed-indicator">SPEED: 1.0x</div>
			<div class="coin-container">
				<div class="css-coin"></div>
				<div id="coin-display">0</div>
				<span id="coin-multiplier">x1</span>
			</div>

			<div id="status-bars">
				<div id="jetpack-status" class="status-bar">
					<div class="status-icon">ğŸš€</div>
					<div id="jetpack-timer" class="status-timer">08.0s</div>
				</div>
				<div id="magnet-status" class="status-bar">
					<div class="status-icon">ğŸ§²</div>
					<div id="magnet-timer" class="status-timer">10.0s</div>
				</div>

				<div id="shield-status" class="status-bar">
					<div class="status-icon">ğŸ›¡ï¸</div>
					<div id="shield-text" class="status-timer">READY</div>
				</div>
			</div>
		</div>

		<div id="main-menu" class="menu-screen">
			<div id="main-menu-coins">
				<div class="css-coin"></div>
				<span id="menu-coin-count">0</span>
			</div>
			<div class="game-title">FREE RUN<br>MOON CHASER</div>

			<div class="menu-content">
				<button id="play-btn" class="btn-3d play-btn-style" onclick="startGame(event)">TAP TO
					PLAY</button>
				<button id="store-btn" class="btn-3d store-btn-style" onclick="Store.show(event)">SUPPLY
					STORE</button>
				<button id="char-btn" class="btn-3d char-btn-style"
					onclick="CharSys.show(event)">CHARACTERS</button>
				<button id="rank-btn" class="btn-3d rank-btn-style"
					onclick="Leaderboard.show(event)">LEADERBOARD</button>
			</div>

			<div id="controls-hint">
				<div class="control-row">
					<div><span class="key-cap key-move">â†</span> <span
							class="key-cap key-move">â†’</span></div>
					<span class="control-label">MOVE</span>
				</div>
				<div class="control-row">
					<div><span class="key-cap key-jump">â†‘</span></div>
					<span class="control-label">JUMP</span>
					<div style="width:15px"></div>
					<div><span class="key-cap key-roll">â†“</span></div>
					<span class="control-label">ROLL</span>
				</div>
				<div class="swipe-hint"><span class="swipe-icon">ğŸ‘†</span> (Swipe on Screen)</div>
			</div>
		</div>

		<div id="pause-screen" class="menu-screen hidden">
			<div class="pause-container">
				<div id="pause-title" class="pause-title">PAUSED</div>
				<button id="resume-btn" class="btn-3d resume-btn-style"
					onclick="togglePause(event)">RESUME</button>
				<button id="pause-home-btn" class="btn-3d lb-close-btn" onclick="goHome(event)">MAIN
					MENU</button>
			</div>
		</div>

		<div id="game-over-screen" style="display: none;">
			<h2 class="go-title">GAME OVER</h2>

			<div class="go-stats-container">
				<div class="go-row">
					<span class="go-label">SCORE / åˆ†æ•°</span>
					<span class="go-value" id="go-score">0</span>
				</div>
				<div class="go-row">
					<span class="go-label">COINS / é‡‘å¸</span>
					<span class="go-value" id="go-coins">0</span>
				</div>
				<div class="go-row">
					<span class="go-label">DISTANCE / è·ç¦»</span>
					<span class="go-value" id="go-dist">0m</span>
				</div>
				<div class="go-divider"></div>
				<div class="go-row highlight">
					<span class="go-label">BEST / æœ€ä½³</span>
					<span class="go-value" id="go-best">0</span>
				</div>
			</div>

			<div class="go-input-container">
				<input type="text" id="new-name-input" class="go-input" placeholder="Enter Name"
					maxlength="8">
			</div>

			<div class="go-btn-group">
				<button id="go-restart-btn" onclick="resetGame()">â†» AGAIN</button>
				<button id="go-menu-btn" onclick="showMainMenu()">â˜° MENU</button>
			</div>
		</div>

		<div id="store-screen" class="menu-screen hidden">
			<div class="store-container">
				<div class="store-header">
					<div class="game-title"
						style="font-size:30px; margin:0; transform:none; animation:none;">SUPPLY
						STORE</div>
					<div class="store-balance">
						<div class="css-coin" style="width:25px; height:25px;"></div>
						<span id="store-coin-count">0</span>
					</div>
				</div>
				<div class="store-grid">
					<div class="store-item">
						<div class="item-icon">ğŸ§²</div>
						<div id="item-name-mag" class="item-name">Magnet Start</div>
						<div id="item-desc-mag" class="item-desc">Start run with Magnet active
						</div>
						<div id="item-own-mag" class="item-owned">Owned: 0</div>
						<button id="buy-mag-btn" class="buy-btn" onclick="Store.buy('magnet')">
							<div class="css-coin" style="width:15px; height:15px;"></div>
							100
						</button>
						<div class="toggle-container">
							<label class="switch">
								<input type="checkbox" id="check-mag"
									onchange="Store.toggle('magnet')">
								<span class="slider"></span>
							</label>
							<span id="auto-use-mag">Auto-Use</span>
						</div>
					</div>
					<div class="store-item">
						<div class="item-icon">ğŸš€</div>
						<div id="item-name-jet" class="item-name">Jetpack Start</div>
						<div id="item-desc-jet" class="item-desc">Start run with Jetpack active
						</div>
						<div id="item-own-jet" class="item-owned">Owned: 0</div>
						<button id="buy-jet-btn" class="buy-btn" onclick="Store.buy('jetpack')">
							<div class="css-coin" style="width:15px; height:15px;"></div>
							200
						</button>
						<div class="toggle-container">
							<label class="switch">
								<input type="checkbox" id="check-jet"
									onchange="Store.toggle('jetpack')">
								<span class="slider"></span>
							</label>
							<span id="auto-use-jet">Auto-Use</span>
						</div>
					</div>
				</div>
				<button id="store-close-btn" class="btn-3d lb-close-btn"
					style="background:#3498db; box-shadow:0 5px 0 #2980b9;"
					onclick="closeStore(event)">BACK</button>
			</div>
		</div>

		<div id="char-screen" class="menu-screen hidden">
			<div class="store-container">
				<div class="store-header">
					<div id="char-title" class="game-title"
						style="font-size:30px; margin:0; transform:none; animation:none;">
						CHARACTERS</div>
					<div class="store-balance">
						<div class="css-coin" style="width:25px; height:25px;"></div>
						<span id="char-coin-count">0</span>
					</div>
				</div>
				<div id="char-grid" class="store-grid">
				</div>
				<button id="char-close-btn" class="btn-3d lb-close-btn"
					style="background:#3498db; box-shadow:0 5px 0 #2980b9;"
					onclick="CharSys.close(event)">BACK</button>
			</div>
		</div>

		<div id="game-over" class="menu-screen hidden">
			<div class="game-title" style="font-size: 48px; color: #ff6b6b;">CRASHED!</div>
			<div id="final-score-box"
				style="background:rgba(0,0,0,0.6); padding:15px; border-radius:15px; text-align:center; margin-bottom:15px;">
				<div style="color:white; font-size: 16px;">SCORE</div>
				<div id="final-score-val" style="color:#FFD700; font-size:36px; font-weight:900;">0
				</div>
			</div>
			<input type="text" id="name-input" placeholder="Enter Name" maxlength="8">
			<button id="restart-btn" class="btn-3d retry-btn-style">SAVE & RETRY</button>
			<button id="home-btn" class="btn-3d home-btn-style" onclick="goHome(event)">MAIN MENU</button>
		</div>

		<div id="leaderboard-screen" class="menu-screen hidden">
			<div class="leaderboard-container">
				<div id="lb-title-text" class="game-title"
					style="font-size: 32px; margin-bottom: 20px;">TOP RUNNERS
				</div>
				<table class="lb-table">
					<thead>
						<tr>
							<th id="th-rank">RANK</th>
							<th id="th-name" onclick="Leaderboard.sort('name')">NAME <span
									id="sort-name" class="sort-icon"></span></th>
							<th id="th-score" onclick="Leaderboard.sort('score')">SCORE
								<span id="sort-score" class="sort-icon">â–¼</span>
							</th>
							<th id="th-time" onclick="Leaderboard.sort('time')">TIME <span
									id="sort-time" class="sort-icon"></span></th>
						</tr>
					</thead>
					<tbody id="lb-body"></tbody>
				</table>
				<button id="lb-close-btn" class="btn-3d lb-close-btn"
					onclick="document.getElementById('leaderboard-screen').classList.add('hidden')">CLOSE</button>
			</div>
		</div>
	</div>

	<script>
		/**
		 * FREE RUN: MOON CHASER (V23 - V20 Base + Character System)
		 */

		const CONFIG = {
			LANES: [-3.5, 0, 3.5],
			TRACK_LENGTH: 200,
			PLAYER_SPEED_BASE: 15,
			PLAYER_SPEED_MAX: 50,
			SPEED_ACCELERATION: 0.8,
			JUMP_FORCE: 0.4,
			GRAVITY: 0.015,
			MAGNET_DURATION: 10,
			JETPACK_DURATION: 8,
			JETPACK_HEIGHT: 7,
			MAGNET_RANGE: 15,
			COST_MAGNET: 100,
			COST_JETPACK: 200,
			INITIAL_COINS: 50000,
			CYCLE_DURATION: 120,
			START_TIME_OFFSET: 0.4, // 0.4 æ¥è¿‘æ­£åˆï¼Œä¿è¯å¼€å±€æ˜¯äº®å¤©
			MOVING_TRAIN_SPAWN_OFFSET: 180,
			TRAIN_COOLDOWN: 3000,
			INVINCIBLE_DURATION: 3.0,

			// === è§†è§‰ç¿»æ–°é…ç½® ===
			COLORS: {
				// å¤©ç©ºé¢œè‰²æ”¹ä¸ºæ¸…æ–°çš„æ¸å˜è“
				skyNight: 0x0b1026,
				skySunrise: 0xff9a76,
				skyDay: 0x4faaf0,  // æ¹›è“è‰² (å‚è€ƒå›¾é£æ ¼)
				skySunset: 0xfd79a8,

				coin: 0xFFD700,
				// åœ°é¢æ”¹ä¸ºæµ…ç°è‰²ï¼Œåè¡¬é˜´å½±
				ground: 0xeaeaea
			},

			// é›¾æ°”è®¾ç½®ï¼šæ¨è¿œï¼Œä¸è¦ç³Šåœ¨è„¸ä¸Š
			FOG: {
				near: 60,  // ä» 60ç±³å¤„æ‰å¼€å§‹æœ‰é›¾ (åŸæ¥æ˜¯20)
				far: 250   // åˆ° 250ç±³å¤„å®Œå…¨çœ‹ä¸è§ (åŸæ¥æ˜¯120)
			},

			SPECIAL_COINS: {
				gem: { value: 50, color: 0x00FFFF, chance: 0.08, rotateSpeed: 2.0 },
				star: { value: 100, color: 0xE74C3C, ringColor: 0xFFD700, chance: 0.03, rotateSpeed: 1.5 }
			},
			CLOUDS: { count: 15, minHeight: 35, maxHeight: 70, rangeX: 120, depth: 300, speed: 3 }
		};

		let currentGroundY = 0; // å½“å‰çš„åœ°é¢é«˜åº¦ (0=åœ°é¢, 4=è½¦é¡¶)
		let onTrain = false;    // ç©å®¶å½“å‰æ˜¯å¦åœ¨ç«è½¦ä¸Š

		// --- V23: Character Data ---
		const CHARACTERS = {
			'default': { name: "Runner", color: 0xE0E0E0, glow: 0x00FFFF, cost: 0 },
			'crimson': { name: "Crimson", color: 0xE74C3C, glow: 0xFFD700, cost: 500 },
			'stealth': { name: "Stealth", color: 0x2C3E50, glow: 0xFF00FF, cost: 1000 },
			'golden': { name: "Midas", color: 0xFFD700, glow: 0xFFFFFF, cost: 2000 }
		};

		const AudioSys = {
			ctx: null,
			muted: false,
			bgmNode: null, // BGM æ€»çº¿
			sfxNode: null, // éŸ³æ•ˆ æ€»çº¿
			bgmVolume: 1.0, // é»˜è®¤èƒŒæ™¯éŸ³ä¹å¤§ä¸€ç‚¹ (0.0 - 1.0)
			sfxVolume: 0.1, // é»˜è®¤éŸ³æ•ˆå°ä¸€ç‚¹
			isPlayingBGM: false,
			bgmTimer: null,

			init: function () {
				if (!this.ctx) {
					const AudioContext = window.AudioContext || window.webkitAudioContext;
					this.ctx = new AudioContext();

					// 1. åˆ›å»º BGM éŸ³é‡æ§åˆ¶èŠ‚ç‚¹
					this.bgmNode = this.ctx.createGain();
					this.bgmNode.gain.value = this.bgmVolume;
					this.bgmNode.connect(this.ctx.destination);

					// 2. åˆ›å»º SFX éŸ³é‡æ§åˆ¶èŠ‚ç‚¹
					this.sfxNode = this.ctx.createGain();
					this.sfxNode.gain.value = this.sfxVolume;
					this.sfxNode.connect(this.ctx.destination);

					// åˆå§‹åŒ– UI æ»‘å—çš„å€¼
					this.updateSliderUI();
				}
				if (this.ctx.state === 'suspended') this.ctx.resume();
			},

			// æ›´æ–° UI æ•°å­—æ˜¾ç¤º
			updateSliderUI: function () {
				const bgmSlider = document.getElementById('bgm-slider');
				const sfxSlider = document.getElementById('sfx-slider');
				if (bgmSlider) { bgmSlider.value = this.bgmVolume; document.getElementById('bgm-val').innerText = Math.round(this.bgmVolume * 100) + "%"; }
				if (sfxSlider) { sfxSlider.value = this.sfxVolume; document.getElementById('sfx-val').innerText = Math.round(this.sfxVolume * 100) + "%"; }
			},

			setBGMVol: function (val) {
				this.bgmVolume = parseFloat(val);
				if (this.bgmNode) this.bgmNode.gain.value = this.muted ? 0 : this.bgmVolume;
				document.getElementById('bgm-val').innerText = Math.round(this.bgmVolume * 100) + "%";
			},

			setSFXVol: function (val) {
				this.sfxVolume = parseFloat(val);
				if (this.sfxNode) this.sfxNode.gain.value = this.muted ? 0 : this.sfxVolume;
				document.getElementById('sfx-val').innerText = Math.round(this.sfxVolume * 100) + "%";
				// æ’­æ”¾ä¸€ä¸ªæµ‹è¯•éŸ³æ•ˆ
				if (!this.muted && val > 0) this.playTone(800, 'sine', 0.1, 0.5);
			},

			toggle: function () {
				this.muted = !this.muted;
				document.getElementById('sound-btn').innerText = this.muted ? "ğŸ”‡" : "ğŸ”Š";

				// é™éŸ³æ—¶å°†æ€»çº¿éŸ³é‡è®¾ä¸º0ï¼Œå–æ¶ˆé™éŸ³æ¢å¤è®¾å®šå€¼
				if (this.bgmNode) this.bgmNode.gain.value = this.muted ? 0 : this.bgmVolume;
				if (this.sfxNode) this.sfxNode.gain.value = this.muted ? 0 : this.sfxVolume;

				if (!this.muted && gameActive && !isPaused) this.startBGM();
			},

			// æ’­æ”¾éŸ³æ•ˆ (è¿æ¥åˆ° sfxNode)
			playTone: function (freq, type, duration, relativeVol = 1.0) {
				if (!this.ctx) return;
				const osc = this.ctx.createOscillator();
				const gain = this.ctx.createGain();
				osc.type = type;
				osc.frequency.setValueAtTime(freq, this.ctx.currentTime);

				// æ³¨æ„ï¼šè¿™é‡Œçš„ relativeVol æ˜¯ç›¸å¯¹äº sfxNode çš„æ¯”ä¾‹
				gain.gain.setValueAtTime(relativeVol, this.ctx.currentTime);
				gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);

				osc.connect(gain);
				gain.connect(this.sfxNode); // å…³é”®ï¼šè¿åˆ° SFX æ€»çº¿ï¼Œè€Œä¸æ˜¯ destination

				osc.start();
				osc.stop(this.ctx.currentTime + duration);
			},

			playCoin: function () {
				// é‡‘å¸å£°éŸ³ç¨å¾®å¤§ä¸€ç‚¹ç‚¹
				this.playTone(1200, 'sine', 0.1, 0.6);
				setTimeout(() => this.playTone(1800, 'sine', 0.2, 0.4), 50);
			},

			playPowerup: function () {
				if (!this.ctx) return;
				const osc = this.ctx.createOscillator();
				const gain = this.ctx.createGain();
				osc.type = 'sawtooth';
				osc.frequency.setValueAtTime(200, this.ctx.currentTime);
				osc.frequency.linearRampToValueAtTime(800, this.ctx.currentTime + 0.5);
				gain.gain.setValueAtTime(0.3, this.ctx.currentTime); // é™ä½ä¸€ç‚¹åŸºç¡€å¢ç›Š
				gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 0.5);

				osc.connect(gain);
				gain.connect(this.sfxNode); // è¿åˆ° SFX æ€»çº¿

				osc.start(); osc.stop(this.ctx.currentTime + 0.5);
			},

			playCrash: function () {
				if (!this.ctx) return;
				const bufferSize = this.ctx.sampleRate * 0.5;
				const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
				const data = buffer.getChannelData(0);
				for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
				const noise = this.ctx.createBufferSource();
				noise.buffer = buffer;
				const gain = this.ctx.createGain();
				gain.gain.setValueAtTime(0.5, this.ctx.currentTime);
				gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.5);

				noise.connect(gain);
				gain.connect(this.sfxNode); // è¿åˆ° SFX æ€»çº¿

				noise.start();
			},

			playSmash: function (isBig) {
				if (!this.ctx) return;
				const osc = this.ctx.createOscillator();
				const gain = this.ctx.createGain();
				osc.type = isBig ? 'sawtooth' : 'square';
				osc.frequency.setValueAtTime(isBig ? 100 : 300, this.ctx.currentTime);
				osc.frequency.exponentialRampToValueAtTime(10, this.ctx.currentTime + 0.15);

				// åŸºç¡€éŸ³é‡è°ƒå°
				const vol = isBig ? 0.6 : 0.3;
				gain.gain.setValueAtTime(vol, this.ctx.currentTime);
				gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.15);

				osc.connect(gain);
				gain.connect(this.sfxNode); // è¿åˆ° SFX æ€»çº¿

				osc.start();
				osc.stop(this.ctx.currentTime + 0.2);
			},

			startBGM: function () {
				if (this.muted || !this.ctx || this.isPlayingBGM) return;
				this.isPlayingBGM = true;

				// ç¡®ä¿éŸ³é‡è®¾ç½®æ­£ç¡®
				if (this.bgmNode) this.bgmNode.gain.value = this.bgmVolume;

				this.bgmTimer = setInterval(() => {
					if (!this.isPlayingBGM) return;
					const t = this.ctx.currentTime;
					// BGM é¢‘ç‡ç¨å¾®ä¸°å¯Œä¸€ç‚¹
					const bassFreq = [55, 55, 55, 55, 65, 65, 49, 49][Math.floor(Date.now() / 250) % 8];

					const osc = this.ctx.createOscillator();
					const gain = this.ctx.createGain();
					osc.type = 'sawtooth';
					osc.frequency.setValueAtTime(bassFreq, t);

					const filter = this.ctx.createBiquadFilter();
					filter.type = 'lowpass';
					filter.frequency.setValueAtTime(400, t); // ç¨å¾®é—·ä¸€ç‚¹ï¼Œä¸è¦å¤ªåˆºè€³

					// BGM åŸºç¡€å¢ç›Šè®¾ä¸º 0.2 (é…åˆ Master BGM Volume 0.6 æ•ˆæœä¸é”™)
					gain.gain.setValueAtTime(0.2, t);
					gain.gain.exponentialRampToValueAtTime(0.001, t + 0.2);

					osc.connect(filter);
					filter.connect(gain);
					gain.connect(this.bgmNode); // å…³é”®ï¼šè¿åˆ° BGM æ€»çº¿

					osc.start(t); osc.stop(t + 0.2);
				}, 250);
			},

			stopBGM: function () {
				this.isPlayingBGM = false;
				if (this.bgmTimer) clearInterval(this.bgmTimer);
			}
		};
		window.AudioSys = AudioSys;

		// --- è®¾ç½®ç•Œé¢æ§åˆ¶å‡½æ•° ---
		function openSettings(e) {
			if (e && e.stopPropagation) e.stopPropagation();
			// åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡(å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ç‚¹å‡»)
			AudioSys.init();
			document.getElementById('settings-screen').classList.remove('hidden');
			// å¦‚æœåœ¨æ¸¸æˆä¸­ï¼Œè‡ªåŠ¨æš‚åœ
			if (gameActive && !isPaused) togglePause();
		}
		window.openSettings = openSettings;

		function closeSettings(e) {
			if (e && e.stopPropagation) e.stopPropagation();
			document.getElementById('settings-screen').classList.add('hidden');
		}
		window.closeSettings = closeSettings;

		// ç‰¹æ•ˆç³»ç»Ÿ å¤„ç†æ’æ“Šæ™‚ç”¢ç”Ÿçš„ â€œç²‰ç¢â€æ•ˆæœ
		const VFX = {
			particles: [],
			material: new THREE.MeshBasicMaterial({ color: 0xffffff }), // é»˜è®¤ç™½è‰²ï¼Œä¼šè¢«é¡¶ç‚¹é¢œè‰²è¦†ç›–

			// è§¦å‘çˆ†ç‚¸ç‰¹æ•ˆ
			explode: function (pos, color, scale = 1.0) {
				const count = 8; // ç¢ç‰‡æ•°é‡ï¼Œä¸ç”¨å¤ªå¤šï¼Œä¿æŒæ€§èƒ½
				const geo = new THREE.BoxGeometry(0.3 * scale, 0.3 * scale, 0.3 * scale);
				const mat = new THREE.MeshBasicMaterial({ color: color });

				for (let i = 0; i < count; i++) {
					const mesh = new THREE.Mesh(geo, mat);
					mesh.position.copy(pos);

					// éšæœºæ•£å°„é€Ÿåº¦
					mesh.userData = {
						vel: new THREE.Vector3(
							(Math.random() - 0.5) * 15,
							Math.random() * 10 + 5, // å‘ä¸Šç‚¸
							(Math.random() - 0.5) * 15
						),
						life: 1.0 // å­˜æ´»æ—¶é—´
					};

					scene.add(mesh);
					this.particles.push(mesh);
				}
			},

			// æ¯å¸§æ›´æ–°ç²’å­
			update: function (delta) {
				for (let i = this.particles.length - 1; i >= 0; i--) {
					const p = this.particles[i];
					p.userData.life -= delta * 2; // 0.5ç§’åæ¶ˆå¤±

					if (p.userData.life <= 0) {
						scene.remove(p);
						this.particles.splice(i, 1);
					} else {
						// ç‰©ç†æ¨¡æ‹Ÿï¼šé‡åŠ›ä¸‹è½
						p.userData.vel.y -= 30 * delta;
						p.position.add(p.userData.vel.clone().multiplyScalar(delta));
						p.rotation.x += p.userData.vel.z * delta;
						p.rotation.z += p.userData.vel.x * delta;
						p.scale.setScalar(p.userData.life); // æ…¢æ…¢å˜å°
					}
				}
			}
		};

		const GameData = {
			coins: 0,
			inventory: { magnet: 0, jetpack: 0 },
			settings: { autoMagnet: false, autoJetpack: false },
			// V23: New Data for Chars
			unlockedChars: ['default'],
			curChar: 'default',

			load: function () {
				const saved = localStorage.getItem('moonChaser_save');
				if (saved) {
					try {
						const parsed = JSON.parse(saved);
						this.coins = parsed.coins || 0;
						this.inventory = parsed.inventory || { magnet: 0, jetpack: 0 };
						this.settings = parsed.settings || { autoMagnet: false, autoJetpack: false };
						this.unlockedChars = parsed.unlockedChars || ['default'];
						this.curChar = parsed.curChar || 'default';
					} catch (e) { this.coins = CONFIG.INITIAL_COINS; }
				} else {
					this.coins = CONFIG.INITIAL_COINS;
					this.save();
				}
				if (document.getElementById('menu-coin-count')) document.getElementById('menu-coin-count').innerText = this.coins;
			},
			save: function () {
				localStorage.setItem('moonChaser_save', JSON.stringify({
					coins: this.coins,
					inventory: this.inventory,
					settings: this.settings,
					unlockedChars: this.unlockedChars,
					curChar: this.curChar
				}));
			},
			addCoins: function (amount) { this.coins += amount; this.save(); if (document.getElementById('menu-coin-count')) document.getElementById('menu-coin-count').innerText = this.coins; }
		};

		const LANG = {
			en: {
				title: "FREE RUN<br>MOON CHASER",
				play: "TAP TO PLAY", crashed: "CRASHED!", score: "SCORE", tryAgain: "TRY AGAIN", mainMenu: "MAIN MENU",
				controls: `
            <div class="control-row">
                <div><span class="key-cap key-move">â†</span> <span class="key-cap key-move">â†’</span></div>
                <span class="control-label">MOVE</span>
            </div>
            <div class="control-row">
                <div><span class="key-cap key-jump">â†‘</span></div>
                <span class="control-label">JUMP</span>
                <div style="width:15px"></div>
                <div><span class="key-cap key-roll">â†“</span></div>
                <span class="control-label">ROLL</span>
            </div>
            <div class="swipe-hint"><span class="swipe-icon">ğŸ‘†</span> (Swipe on Screen)</div>
        `,
				rankBtn: "LEADERBOARD", lbTitle: "TOP RUNNERS", lbRank: "RANK", lbName: "NAME", lbScore: "SCORE", lbTime: "TIME", lbClose: "CLOSE", lbPlaceholder: "Enter Name", lbSave: "SAVE & RETRY", lbNoRecord: "No records yet.",
				storeBtn: "SUPPLY STORE", storeTitle: "SUPPLY STORE", storeBack: "BACK",
				itemNameMag: "Magnet Start", itemDescMag: "Start run with Magnet", itemOwn: "Owned: ", autoUse: "Auto-Use",
				itemNameJet: "Jetpack Start", itemDescJet: "Start run with Jetpack",
				pauseTitle: "PAUSED", resume: "RESUME", pauseMenu: "MAIN MENU",
				charTitle: "CHARACTERS", charBack: "BACK", owned: "OWNED", equip: "EQUIP", equipped: "EQUIPPED", buy: "BUY"
			},
			cn: {
				title: "è‡ªç”±å¥”è·‘<br>é€æœˆè€…",
				play: "ç‚¹å‡»å¼€å§‹", crashed: "æ¸¸æˆç»“æŸ!", score: "æœ€ç»ˆå¾—åˆ†", tryAgain: "å†æ¥ä¸€æ¬¡", mainMenu: "è¿”å›ä¸»èœå•",
				controls: `
            <div class="control-row">
                <div><span class="key-cap key-move">â†</span> <span class="key-cap key-move">â†’</span></div>
                <span class="control-label">å·¦å³å˜é“</span>
            </div>
            <div class="control-row">
                <div><span class="key-cap key-jump">â†‘</span></div>
                <span class="control-label">è·³è·ƒ</span>
                <div style="width:15px"></div>
                <div><span class="key-cap key-roll">â†“</span></div>
                <span class="control-label">ç¿»æ»š</span>
            </div>
            <div class="swipe-hint"><span class="swipe-icon">ğŸ‘†</span> (æ‰‹æœºç«¯æ”¯æŒæ»‘åŠ¨æ“ä½œ)</div>
        `,
				rankBtn: "æ’è¡Œæ¦œ", lbTitle: "é¡¶çº§å¥”è·‘è€…", lbRank: "æ’å", lbName: "åå­—", lbScore: "åˆ†æ•°", lbTime: "æ—¶é•¿", lbClose: "å…³é—­", lbPlaceholder: "è¾“å…¥åå­—", lbSave: "ä¿å­˜å¹¶é‡è¯•", lbNoRecord: "æš‚æ— è®°å½•ï¼Œå¿«å»ç©ä¸€æŠŠï¼",
				storeBtn: "è¡¥ç»™å•†åº—", storeTitle: "è¡¥ç»™å•†åº—", storeBack: "è¿”å›",
				itemNameMag: "å¼€å±€ç£é“", itemDescMag: "å¼€å±€è‡ªåŠ¨æ¿€æ´»ç£é“", itemOwn: "æ‹¥æœ‰: ", autoUse: "è‡ªåŠ¨ä½¿ç”¨",
				itemNameJet: "å¼€å±€é£è¡Œ", itemDescJet: "å¼€å±€è‡ªåŠ¨ä½¿ç”¨å–·æ°”èƒŒåŒ…",
				pauseTitle: "æ¸¸æˆæš‚åœ", resume: "ç»§ç»­æ¸¸æˆ", pauseMenu: "è¿”å›ä¸»èœå•",
				charTitle: "è§’è‰²é€‰æ‹©", charBack: "è¿”å›", owned: "å·²æ‹¥æœ‰", equip: "è£…å¤‡", equipped: "ä½¿ç”¨ä¸­", buy: "è´­ä¹°"
			}
		};

		// å¦‚æœæµè§ˆå™¨è¯­è¨€æ˜¯ zh-CN æˆ– zh-TW ç­‰ï¼Œé»˜è®¤ç”¨ cnï¼Œå¦åˆ™ç”¨ en
		let currentLang = navigator.language.startsWith('zh') ? 'cn' : 'en';

		let scene, camera, renderer, clock;
		let player;
		let gameActive = false;
		let isPaused = false;
		let score = 0, coins = 0, distance = 0, survivalTime = 0;
		let speed = CONFIG.PLAYER_SPEED_BASE;

		let hasShield = false;      // æ˜¯å¦æ‹¥æœ‰æŠ¤ç›¾
		let isInvincible = false;   // æ˜¯å¦å¤„äºæ— æ•ŒçŠ¶æ€
		let invincibleTimer = 0;    // æ— æ•Œå€’è®¡æ—¶

		// Environment references
		let ambientLight, dirLight, sunMesh;

		// ğŸ”¥ğŸ”¥ğŸ”¥ æ–°å¢ï¼šå­˜æ”¾ç§‘å¹»æ˜Ÿçƒçš„æ•°ç»„ ğŸ”¥ğŸ”¥ğŸ”¥
		let sciFiElements = [];

		let cycleTime = CONFIG.CYCLE_DURATION * CONFIG.START_TIME_OFFSET;

		const activeTracks = [];
		const activeObstacles = [];
		const activeCoins = [];
		const activeMagnets = [];
		const activeJetpacks = [];
		const activeDecorations = [];
		let world = { lastSpawnZ: 0 };

		let targetLane = 1;
		let isJumping = false, isSliding = false;
		let verticalVelocity = 0, slideTimer = 0;
		let magnetActive = false, magnetTimer = 0;
		let jetpackActive = false, jetpackTimer = 0;

		// Materials
		let buildingMaterials = [];
		let trainBodyMat, trainWindowMat, trainWheelMat;

		function init() {
			document.getElementById('loading').style.display = 'none';
			GameData.load();
			scene = new THREE.Scene();
			scene.background = new THREE.Color(CONFIG.COLORS.skyDay);
			// ğŸ”¥ ä¿®æ”¹è¿™é‡Œï¼šä½¿ç”¨ CONFIG.FOG çš„å‚æ•°
			scene.fog = new THREE.Fog(CONFIG.COLORS.skyDay, CONFIG.FOG.near, CONFIG.FOG.far);
			camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 300);
			camera.position.set(0, 4, 10);
			camera.rotation.set(-0.1, 0, 0);
			renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
			renderer.setSize(window.innerWidth, window.innerHeight);
			renderer.shadowMap.enabled = true;
			renderer.shadowMap.type = THREE.PCFSoftShadowMap;
			document.getElementById('game-container').appendChild(renderer.domElement);

			createBuildingMaterials();
			createTrainMaterials();
			createEnvironment();
			createPlayerModel();
			CloudSystem.init(scene);
			setupInputs();
			setupUI();
			clock = new THREE.Clock();
			animate();
		}

		function createBuildingMaterials() {
			buildingMaterials = [];
			const colors = [0x48dbfb, 0xff6b6b, 0xfeca57, 0x1dd1a1, 0x5f27cd, 0xff9ff3];

			colors.forEach(col => {
				const canvas = document.createElement('canvas');
				canvas.width = 64;
				canvas.height = 64;
				const ctx = canvas.getContext('2d');

				// A. å¡«å……åº•è‰²
				ctx.fillStyle = '#' + new THREE.Color(col).getHexString();
				ctx.fillRect(0, 0, 64, 64);

				// B. ç”»çª—æˆ· (ä¿®æ”¹äº†è¿™é‡Œ)
				ctx.fillStyle = '#ffffdd';

				// --- ä¿®æ”¹ç‚¹ 1ï¼šå¢å¤§å¾ªç¯é—´è· ---
				// åŸæ¥æ˜¯ y+=12, x+=12ã€‚ç°åœ¨æ”¹ä¸º 18 å’Œ 16ï¼Œé—´è·æ˜¾è‘—å¢å¤§ã€‚
				// èµ·å§‹ç‚¹ä¹Ÿå¾®è°ƒäº†ä¸€ä¸‹è®©å®ƒçœ‹èµ·æ¥æ›´å±…ä¸­
				for (let y = 10; y < 60; y += 18) {
					for (let x = 8; x < 60; x += 16) {
						// --- ä¿®æ”¹ç‚¹ 2ï¼šå¤§å¹…æé«˜éšæœºè·³è¿‡çš„æ¦‚ç‡ ---
						// åŸæ¥æ˜¯ > 0.15 (85%å‡ ç‡ç”»)ã€‚ç°åœ¨æ”¹ä¸º > 0.4 (åªæœ‰ 60% å‡ ç‡ç”»)ã€‚
						// æ„å‘³ç€æ¥è¿‘ä¸€åŠçš„çª—æˆ·ä½æ˜¯ç©ºçš„ã€‚
						if (Math.random() > 0.4) {
							// ç¨å¾®è°ƒæ•´ä¸€ä¸‹çª—æˆ·å¤§å°ï¼Œè®©å®ƒåœ¨ç¨€ç–æ—¶ä¸é‚£ä¹ˆçªå…€
							ctx.fillRect(x, y, 7, 9);
						}
					}
				}

				const texture = new THREE.CanvasTexture(canvas);
				texture.magFilter = THREE.NearestFilter;
				texture.minFilter = THREE.NearestFilter;
				texture.wrapS = THREE.RepeatWrapping;
				texture.wrapT = THREE.RepeatWrapping;

				// --- ä¿®æ”¹ç‚¹ 3ï¼šå‡å°‘å‚ç›´é‡å¤ ---
				// åŸæ¥æ˜¯ (1, 5)ï¼Œå¤ªæŒ¤äº†ã€‚æ”¹ä¸º (1, 3)ï¼Œè®©æ¥¼å±‚çœ‹èµ·æ¥æ›´é«˜æŒ‘ï¼Œè§†è§‰å‹åŠ›æ›´å°ã€‚
				texture.repeat.set(1, 3);

				const mat = new THREE.MeshStandardMaterial({
					map: texture,
					color: 0xffffff,
					roughness: 0.9,
					metalness: 0.0,
					emissiveMap: texture,
					emissive: 0xffffff,
					// å‘å…‰å¼ºåº¦ç¨å¾®é™ä½ä¸€ç‚¹ç‚¹ï¼Œé…åˆç¨€ç–æ„Ÿï¼Œæ›´æŸ”å’Œ
					emissiveIntensity: 0.35
				});
				buildingMaterials.push(mat);
			});
		}

		function createTrainMaterials() {
			trainBodyMat = new THREE.MeshPhongMaterial({ color: 0x34495e, shininess: 80, reflectivity: 0.5 });
			const canvas = document.createElement('canvas'); canvas.width = 64; canvas.height = 32;
			const ctx = canvas.getContext('2d'); ctx.fillStyle = '#f1c40f'; ctx.fillRect(0, 5, 64, 22);
			const texture = new THREE.CanvasTexture(canvas); texture.magFilter = THREE.NearestFilter;
			trainWindowMat = new THREE.MeshBasicMaterial({ map: texture, color: 0xffffff });
			trainWheelMat = new THREE.MeshLambertMaterial({ color: 0x111111 });
		}

		function createTrainModel(isMoving) {
			const group = new THREE.Group();
			const body = new THREE.Mesh(new THREE.BoxGeometry(2.6, 3.5, 18), trainBodyMat);
			body.position.y = 2.25; body.castShadow = true; group.add(body);
			const windows = new THREE.Mesh(new THREE.BoxGeometry(2.65, 1.0, 16), trainWindowMat);
			windows.position.y = 3.0; group.add(windows);
			const wheelGeo = new THREE.CylinderGeometry(0.6, 0.6, 3, 16); wheelGeo.rotateZ(Math.PI / 2);
			[-6, -2, 2, 6].forEach(z => { const axle = new THREE.Mesh(wheelGeo, trainWheelMat); axle.position.set(0, 0.6, z); axle.castShadow = true; group.add(axle); });
			if (isMoving) {
				const lightGeo = new THREE.CylinderGeometry(0.4, 0.4, 0.2, 16); lightGeo.rotateX(Math.PI / 2);
				const lightMesh = new THREE.Mesh(lightGeo, new THREE.MeshBasicMaterial({ color: 0xffffff, emissive: 0xffffff, emissiveIntensity: 1 }));
				lightMesh.position.set(0, 2, 9.1); group.add(lightMesh);
			}
			group.userData.isObstacle = true;
			if (isMoving) { group.userData.isMovingTrain = true; group.userData.trainSpeed = 35; }
			return group;
		}

		// ==========================================
		//   å®šä¹‰è§’è‰²æ„å»ºå™¨ (Character Builders)
		// ==========================================

		// æè´¨ç¼“å­˜ï¼ˆä¼˜åŒ–æ€§èƒ½ï¼Œé¿å…é‡å¤åˆ›å»ºæè´¨ï¼‰
		const Materials = {
			standard: (col) => new THREE.MeshPhongMaterial({ color: col, shininess: 30, flatShading: false }),
			plastic: (col) => new THREE.MeshLambertMaterial({ color: col }),
			glow: (col) => new THREE.MeshBasicMaterial({ color: col }),
			metal: (col) => new THREE.MeshStandardMaterial({ color: col, roughness: 0.3, metalness: 0.8 }),
			dark: new THREE.MeshPhongMaterial({ color: 0x2c3e50, shininess: 10 })
		};

		// è§’è‰²å·¥å‚
		const CharacterFactory = {
			// åŸºç¡€éª¨æ¶æ„å»ºï¼ˆä¸ºäº†ä¿è¯åŠ¨ç”»é€šç”¨æ€§ï¼Œæ‰€æœ‰è§’è‰²åŸºäºæ­¤ç»“æ„æ‰©å±•ï¼‰
			createBaseSkeleton: function () {
				const group = new THREE.Group();
				// è¿™é‡Œçš„ userData æ˜¯æ¥å£çš„å…³é”®ï¼ŒåŠ¨ç”»å¾ªç¯åªè®¤è¿™äº›åå­—
				group.userData = { head: null, lArm: null, rArm: null, lLeg: null, rLeg: null, pack: null, flames: [] };
				return group;
			},

			// 1. é»˜è®¤è§’è‰²ï¼šèµ›åšè·‘è€… (Runner)
			buildDefault: function (color, glowColor) {
				const player = this.createBaseSkeleton();

				// å¤´ç›” (å¸¦é¢ç½©)
				const headG = new THREE.Group();
				const headMesh = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.55, 0.6), Materials.standard(color));
				const visor = new THREE.Mesh(new THREE.BoxGeometry(0.52, 0.2, 0.4), Materials.glow(glowColor));
				visor.position.set(0, 0.05, 0.15);
				headG.add(headMesh, visor);
				headG.position.y = 1.5;
				player.add(headG); player.userData.head = headG;

				// èº«ä½“
				const body = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.7, 0.35), Materials.standard(color));
				body.position.y = 0.85;
				player.add(body);

				// å››è‚¢ (ä½¿ç”¨æ›´åœ†æ¶¦çš„å‡ ä½•ä½“æ¯”å‚è€ƒå›¾æ›´å¥½çœ‹)
				const limbGeo = new THREE.BoxGeometry(0.18, 0.55, 0.18);
				const limbMat = Materials.dark;

				const lArm = new THREE.Mesh(limbGeo, limbMat); lArm.position.set(-0.38, 1.0, 0);
				const rArm = new THREE.Mesh(limbGeo, limbMat); rArm.position.set(0.38, 1.0, 0);
				const lLeg = new THREE.Mesh(limbGeo, Materials.standard(color)); lLeg.position.set(-0.15, 0.3, 0);
				const rLeg = new THREE.Mesh(limbGeo, Materials.standard(color)); rLeg.position.set(0.15, 0.3, 0);

				player.add(lArm, rArm, lLeg, rLeg);
				Object.assign(player.userData, { lArm, rArm, lLeg, rLeg }); // ç»‘å®šéª¨éª¼

				return player;
			},

			// 2. çº¢è‰²è§’è‰²ï¼šæ­¦å£« (Samurai - æ›´æœ‰æ£±è§’)
			buildCrimson: function (color, glowColor) {
				const player = this.createBaseSkeleton();

				// æ­¦å£«å¤´ç›”
				const headG = new THREE.Group();
				const helmet = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.4, 0.5, 4), Materials.standard(color));
				const hornL = new THREE.Mesh(new THREE.ConeGeometry(0.05, 0.3, 4), Materials.glow(glowColor));
				hornL.position.set(-0.25, 0.2, 0); hornL.rotation.z = 0.5;
				const hornR = new THREE.Mesh(new THREE.ConeGeometry(0.05, 0.3, 4), Materials.glow(glowColor));
				hornR.position.set(0.25, 0.2, 0); hornR.rotation.z = -0.5;
				headG.add(helmet, hornL, hornR);
				headG.position.y = 1.5;
				player.add(headG); player.userData.head = headG;

				// ç›”ç”²èº«ä½“
				const body = new THREE.Mesh(new THREE.CylinderGeometry(0.35, 0.25, 0.7, 6), Materials.standard(0x2c3e50));
				body.position.y = 0.85;
				player.add(body);

				// å¼ºå£®çš„å››è‚¢
				const armGeo = new THREE.BoxGeometry(0.2, 0.6, 0.2);
				const lArm = new THREE.Mesh(armGeo, Materials.standard(color)); lArm.position.set(-0.4, 1.0, 0);
				const rArm = new THREE.Mesh(armGeo, Materials.standard(color)); rArm.position.set(0.4, 1.0, 0);
				const lLeg = new THREE.Mesh(armGeo, Materials.standard(0x111111)); lLeg.position.set(-0.15, 0.3, 0);
				const rLeg = new THREE.Mesh(armGeo, Materials.standard(0x111111)); rLeg.position.set(0.15, 0.3, 0);

				player.add(lArm, rArm, lLeg, rLeg);
				Object.assign(player.userData, { lArm, rArm, lLeg, rLeg });

				return player;
			},

			// 3. éšå½¢è§’è‰²ï¼šå¿è€… (Stealth - çº¤ç»†ï¼Œæµçº¿å‹)
			buildStealth: function (color, glowColor) {
				const player = this.createBaseSkeleton();

				// å¿è€…å¤´å·¾
				const headG = new THREE.Group();
				const head = new THREE.Mesh(new THREE.SphereGeometry(0.28, 16, 16), Materials.standard(color));
				const eye = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.05, 0.2), Materials.glow(glowColor));
				eye.position.set(0, 0, 0.2);
				// é£˜å¸¦ (é™æ€)
				const scarf = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.4, 0.05), Materials.standard(0xff0000));
				scarf.position.set(0, -0.2, -0.3); scarf.rotation.x = 0.5;
				headG.add(head, eye, scarf);
				headG.position.y = 1.5;
				player.add(headG); player.userData.head = headG;

				// ç´§èº«è¡£
				const body = new THREE.Mesh(new THREE.CapsuleGeometry(0.25, 0.5, 4, 8), Materials.standard(0x1a1a1a));
				body.position.y = 0.9;
				player.add(body);

				// çº¤ç»†å››è‚¢
				const limbGeo = new THREE.CylinderGeometry(0.08, 0.06, 0.6, 8);
				const lArm = new THREE.Mesh(limbGeo, Materials.standard(0x333333)); lArm.position.set(-0.32, 1.05, 0);
				const rArm = new THREE.Mesh(limbGeo, Materials.standard(0x333333)); rArm.position.set(0.32, 1.05, 0);
				const lLeg = new THREE.Mesh(limbGeo, Materials.standard(0x333333)); lLeg.position.set(-0.12, 0.3, 0);
				const rLeg = new THREE.Mesh(limbGeo, Materials.standard(0x333333)); rLeg.position.set(0.12, 0.3, 0);

				player.add(lArm, rArm, lLeg, rLeg);
				Object.assign(player.userData, { lArm, rArm, lLeg, rLeg });
				return player;
			},

			// 4. é»„é‡‘è§’è‰²ï¼šæœºå™¨äºº (Bot - ç±»ä¼¼å‚è€ƒå›¾ä½†æ›´ç²¾è‡´)
			buildGolden: function (color, glowColor) {
				const player = this.createBaseSkeleton();

				// æœºå™¨äººåœ†å¤´
				const headG = new THREE.Group();
				const dome = new THREE.Mesh(new THREE.SphereGeometry(0.3, 32, 32), Materials.metal(color));
				const antenna = new THREE.Mesh(new THREE.CylinderGeometry(0.02, 0.02, 0.3), Materials.standard(0x888888));
				antenna.position.y = 0.3;
				headG.add(dome, antenna);
				headG.position.y = 1.5;
				player.add(headG); player.userData.head = headG;

				// æ–¹å—èº«ä½“ (è‡´æ•¬å‚è€ƒå›¾)
				const body = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.6, 0.4), Materials.metal(color));
				body.position.y = 0.9;
				player.add(body);

				// å…³èŠ‚è¿æ¥çš„å››è‚¢ (çƒå½¢å…³èŠ‚ + åœ†æŸ±)
				const jointGeo = new THREE.SphereGeometry(0.12, 16, 16);
				const limbGeo = new THREE.CylinderGeometry(0.1, 0.1, 0.45, 16);

				// æ„å»ºå¸¦å…³èŠ‚çš„æ‰‹è‡‚è¾…åŠ©å‡½æ•°
				const createLimb = (x, y, isLeg) => {
					const g = new THREE.Group();
					g.position.set(x, y, 0);
					const joint = new THREE.Mesh(jointGeo, Materials.standard(0x555555));
					const limb = new THREE.Mesh(limbGeo, Materials.metal(color));
					limb.position.y = isLeg ? -0.25 : -0.25;
					g.add(joint, limb);
					return g;
				};

				const lArm = createLimb(-0.4, 1.1, false);
				const rArm = createLimb(0.4, 1.1, false);
				const lLeg = createLimb(-0.2, 0.5, true);
				const rLeg = createLimb(0.2, 0.5, true);

				player.add(lArm, rArm, lLeg, rLeg);
				Object.assign(player.userData, { lArm, rArm, lLeg, rLeg });

				return player;
			}
		};

		const CoinFactory = {
			// åŸºç¡€é‡‘å¸æè´¨ç¼“å­˜
			materials: {
				gold: new THREE.MeshPhongMaterial({ color: 0xFFD700, shininess: 100, specular: 0xFFFFFF }),
				gem: new THREE.MeshPhongMaterial({ color: 0x00FFFF, shininess: 150, emissive: 0x004444 }),
				starCore: new THREE.MeshPhongMaterial({ color: 0xE74C3C, shininess: 100, emissive: 0x330000 }),
				starRing: new THREE.MeshBasicMaterial({ color: 0xFFD700 })
			},

			// åˆ›å»ºæ™®é€šé‡‘å¸ (åœ†æŸ±ä½“)
			createNormal: function () {
				const geo = new THREE.CylinderGeometry(0.35, 0.35, 0.1, 16);
				geo.rotateZ(Math.PI / 2);
				const mesh = new THREE.Mesh(geo, this.materials.gold);
				mesh.userData = { type: 'normal', value: 1, rotateSpeed: 0.1 };
				return mesh;
			},

			// åˆ›å»ºè“é’»å¸ (å…«é¢ä½“)
			createGem: function () {
				// ä½¿ç”¨å…«é¢ä½“æ¨¡æ‹Ÿé’»çŸ³
				const geo = new THREE.OctahedronGeometry(0.45, 0);
				const mesh = new THREE.Mesh(geo, this.materials.gem);

				// æ·»åŠ ä¸€ä¸ªå‘å…‰çš„å†…éƒ¨çº¿æ¡†ï¼Œå¢åŠ ç§‘æŠ€æ„Ÿ
				const wireGeo = new THREE.WireframeGeometry(geo);
				const wireMat = new THREE.LineBasicMaterial({ color: 0xFFFFFF, transparent: true, opacity: 0.5 });
				const wireframe = new THREE.LineSegments(wireGeo, wireMat);
				mesh.add(wireframe);

				mesh.userData = { type: 'gem', value: CONFIG.SPECIAL_COINS.gem.value, rotateSpeed: CONFIG.SPECIAL_COINS.gem.rotateSpeed };
				return mesh;
			},

			// åˆ›å»ºç´«æ˜Ÿå¸ (å¸¦ç¯çƒä½“)
			createStar: function () {
				const group = new THREE.Group();

				// æ ¸å¿ƒçƒä½“
				const coreGeo = new THREE.IcosahedronGeometry(0.4, 1);
				const core = new THREE.Mesh(coreGeo, this.materials.starCore);
				group.add(core);

				// å¤–éƒ¨æ˜Ÿç¯ (Torus)
				const ringGeo = new THREE.TorusGeometry(0.6, 0.05, 8, 32);
				ringGeo.rotateX(Math.PI / 2); //ä»¥æ­¤è®©ç¯æ°´å¹³
				const ring = new THREE.Mesh(ringGeo, this.materials.starRing);
				group.add(ring);

				// æ ‡è®° group ä¸ºå¯äº¤äº’å¯¹è±¡ï¼Œå¹¶ä¿å­˜ç¯çš„å¼•ç”¨ä»¥ä¾¿æ—‹è½¬
				group.userData = {
					type: 'star',
					value: CONFIG.SPECIAL_COINS.star.value,
					rotateSpeed: CONFIG.SPECIAL_COINS.star.rotateSpeed,
					isGroup: true,
					ring: ring
				};
				return group;
			}
		};

		// ç¨‹åºåŒ–ç”Ÿæˆäº‘ç³»ç»Ÿ
		const CloudSystem = {
			clouds: [],
			material: null, // å…±äº«æè´¨ï¼Œç”¨äºç»Ÿä¸€å˜è‰²

			// --- 1. åˆå§‹åŒ–ï¼šå‡çº§æè´¨ ---
			init: function (scene) {
				// æ”¹ç”¨ StandardMaterialï¼Œä»¥ä¾¿æ›´å¥½åœ°é…åˆæ–°çš„å…‰ç…§ç³»ç»Ÿ
				this.material = new THREE.MeshStandardMaterial({
					color: 0xffffff,
					roughness: 1.0,      // æåº¦ç²—ç³™ï¼Œæ¨¡æ‹Ÿæ£‰èŠ±çš„è´¨æ„Ÿ
					metalness: 0.0,      // éé‡‘å±
					flatShading: true,   // ä¿ç•™ä½å¤šè¾¹å½¢çš„æ£±è§’é£æ ¼
					transparent: true,   // å¼€å¯é€æ˜
					opacity: 0.85,       // ç¨å¾®åšå®ä¸€ç‚¹ï¼Œä¸è¦å¤ªé€
					side: THREE.FrontSide // ä¼˜åŒ–æ€§èƒ½ï¼Œåªæ¸²æŸ“æ­£é¢
				});

				for (let i = 0; i < CONFIG.CLOUDS.count; i++) {
					const cloud = this.createCloud();
					// éšæœºåˆ†å¸ƒ (ä¿æŒä¸å˜)
					cloud.position.set(
						(Math.random() - 0.5) * CONFIG.CLOUDS.rangeX,
						CONFIG.CLOUDS.minHeight + Math.random() * (CONFIG.CLOUDS.maxHeight - CONFIG.CLOUDS.minHeight),
						-Math.random() * CONFIG.CLOUDS.depth
					);

					// ç»™äºˆæ¯æœµäº‘ç‹¬ç‰¹çš„æ¼‚æµ®å‚æ•° (ä¿æŒä¸å˜)
					cloud.userData = {
						speedOffset: 0.8 + Math.random() * 0.4, // ç¨å¾®è°ƒæ…¢ä¸€ç‚¹é€Ÿåº¦ï¼Œæ›´æœ‰å·¨ç‰©æ„Ÿ
						bobSpeed: 0.3 + Math.random() * 0.4,    // ä¸Šä¸‹æµ®åŠ¨æ…¢ä¸€ç‚¹
						bobAmp: 0.5 + Math.random(),
						rotSpeed: (Math.random() - 0.5) * 0.1   // è‡ªè½¬æ…¢ä¸€ç‚¹
					};

					scene.add(cloud);
					this.clouds.push(cloud);
				}
			},

			// --- 2. åˆ›å»ºå•æœµäº‘ï¼šæ ¸å¿ƒå‡çº§ ---
			createCloud: function () {
				const group = new THREE.Group();

				// ğŸ”¥ å…³é”®æ”¹å˜ï¼šä½¿ç”¨ç»†åˆ†ç­‰çº§ä¸º 1 çš„å‡ ä½•ä½“ã€‚
				// 0çº§å¤ªå°–ï¼Œ2çº§å¤ªåœ†ï¼Œ1çº§æ­£å¥½æ˜¯é‚£ç§æŸ”å’Œçš„ä½å¤šè¾¹å½¢é£æ ¼ã€‚
				const puffGeo = new THREE.IcosahedronGeometry(1, 1);

				// A. åˆ›å»ºäº‘æ ¸å¿ƒ (ä¸€ä¸ªå·¨å¤§çš„ä¸»çƒä½“)
				const core = new THREE.Mesh(puffGeo, this.material);
				const coreScale = 5 + Math.random() * 3; // æ ¸å¿ƒå°ºå¯¸
				core.scale.setScalar(coreScale);
				// æ ¸å¿ƒç¨å¾®å‹æ‰ä¸€ç‚¹ï¼Œæ›´åƒäº‘
				core.scale.y *= 0.8;
				core.castShadow = false; // äº‘é€šå¸¸ä¸æŠ•å°„æ¸…æ™°é˜´å½±(å¤ªè€—æ€§èƒ½ä¸”ä¸å¥½çœ‹)
				group.add(core);

				// B. åˆ›å»ºå‘¨å›´çš„äº‘å›¢ç°‡ (å«æ˜Ÿçƒ)
				// æ•°é‡å¢åŠ åˆ° 7-14 ä¸ª
				const numPuffs = 7 + Math.floor(Math.random() * 7);

				for (let i = 0; i < numPuffs; i++) {
					const puff = new THREE.Mesh(puffGeo, this.material);

					// å°ºå¯¸ï¼šæ¯”æ ¸å¿ƒå°ï¼Œä½†äº’ç›¸ä¹‹é—´æœ‰å·®å¼‚
					const scale = (coreScale * 0.4) + Math.random() * (coreScale * 0.5);
					puff.scale.setScalar(scale);

					// ä½ç½®ï¼šå›´ç»•æ ¸å¿ƒéšæœºåˆ†å¸ƒ
					// ä½¿ç”¨çƒé¢åæ ‡åˆ†å¸ƒå¯ä»¥è®©äº‘çœ‹èµ·æ¥æ›´åœ†æ¶¦é¥±æ»¡
					const theta = Math.random() * Math.PI * 2; // æ°´å¹³è§’åº¦
					const phi = (Math.random() * 0.6 + 0.2) * Math.PI; // å‚ç›´è§’åº¦ (é™åˆ¶åœ¨èµ¤é“é™„è¿‘ï¼Œé¿å…é¡¶éƒ¨åº•éƒ¨å¤ªå°–)
					// åŠå¾„ï¼šæ ¸å¿ƒåŠå¾„ä¹˜ä»¥ä¸€ä¸ªç³»æ•°ï¼Œè®©å«æ˜ŸçƒåŠåµŒå…¥æ ¸å¿ƒä¸­
					const radius = coreScale * (0.4 + Math.random() * 0.4);

					// å°†çƒé¢åæ ‡è½¬æ¢ä¸ºç¬›å¡å°”åæ ‡
					puff.position.setFromSphericalCoords(radius, phi, theta);

					// éšæœºæ—‹è½¬æ¯ä¸ªå°äº‘å›¢ï¼Œå¢åŠ æ— åºæ„Ÿ
					puff.rotation.set(Math.random() * Math.PI, Math.random() * Math.PI, 0);

					puff.castShadow = false;
					group.add(puff);
				}

				// C. æ•´ä½“è°ƒæ•´
				// éšæœºæ‹‰ä¼¸ä¸€ä¸‹æ•´æœµäº‘ï¼Œè®©å®ƒä¸è¦å¤ªåœ†
				group.scale.x = 1 + Math.random() * 0.6; // æ¨ªå‘æ‹‰é•¿
				group.scale.y = 0.8 + Math.random() * 0.3; // çºµå‘å‹æ‰
				// éšæœºåˆå§‹æ—‹è½¬
				group.rotation.z = (Math.random() - 0.5) * 0.4;

				return group;
			},

			update: function (delta, playerZ) {
				const time = Date.now() * 0.001;

				this.clouds.forEach(cloud => {
					// 1. ç§»åŠ¨é€»è¾‘ï¼šäº‘æœµå‘åé£˜ï¼Œäº§ç”Ÿè§†å·®
					// è¿™é‡Œçš„é€Ÿåº¦æ˜¯ CONFIG.speed åŠ ä¸Šä¸€ç‚¹éšæœºï¼Œå†å‡å»ç©å®¶çš„é€Ÿåº¦(æ¨¡æ‹Ÿç›¸å¯¹è¿åŠ¨)
					// ä½†ä¸ºäº†ç¾è§‚ï¼Œé€šå¸¸æˆ‘ä»¬è®©äº‘æ…¢é€Ÿå‘åé£˜å³å¯ï¼Œä¸å®Œå…¨ç»‘å®šç©å®¶é€Ÿåº¦ï¼Œå¦åˆ™çœ‹èµ·æ¥åƒèƒŒæ™¯æ¿
					cloud.position.z += CONFIG.CLOUDS.speed * cloud.userData.speedOffset * delta;

					// 2. å¾ªç¯åˆ©ç”¨ï¼šå¦‚æœè·‘å¤ªè¿œäº†ï¼ŒæŒªå›æœ€å‰é¢
					if (cloud.position.z > playerZ + 50) {
						cloud.position.z = playerZ - CONFIG.CLOUDS.depth;
						cloud.position.x = (Math.random() - 0.5) * CONFIG.CLOUDS.rangeX;
						cloud.position.y = CONFIG.CLOUDS.minHeight + Math.random() * (CONFIG.CLOUDS.maxHeight - CONFIG.CLOUDS.minHeight);
					}

					// 3. åŠ¨æ€æ•ˆæœï¼šä¸Šä¸‹æµ®åŠ¨
					cloud.position.y += Math.sin(time * cloud.userData.bobSpeed) * 0.02;

					// 4. ç¼“æ…¢è‡ªè½¬
					cloud.rotation.y += cloud.userData.rotSpeed * delta;
				});
			},

			// æ˜¼å¤œå¾ªç¯é¢œè‰²æ›´æ–°
			updateColor: function (progress) {
				let cloudColor;
				// ç®€å•çš„çº¿æ€§æ’å€¼æ¥å†³å®šäº‘çš„é¢œè‰²
				if (progress < 0.2) { // æ—¥å‡º (æš— -> æ©™)
					const t = progress / 0.2;
					cloudColor = new THREE.Color(0x222244).lerp(new THREE.Color(0xFFAA88), t);
				} else if (progress < 0.5) { // ç™½å¤© (æ©™ -> ç™½)
					const t = (progress - 0.2) / 0.3;
					cloudColor = new THREE.Color(0xFFAA88).lerp(new THREE.Color(0xFFFFFF), t);
				} else if (progress < 0.7) { // æ—¥è½ (ç™½ -> ç´«çº¢)
					const t = (progress - 0.5) / 0.2;
					cloudColor = new THREE.Color(0xFFFFFF).lerp(new THREE.Color(0xFF88AA), t);
				} else { //å“ªæ€• (ç´«çº¢ -> æš—è“)
					const t = (progress - 0.7) / 0.3;
					cloudColor = new THREE.Color(0xFF88AA).lerp(new THREE.Color(0x111122), t);
				}

				if (this.material) {
					this.material.color.copy(cloudColor);
					// å¤œæ™šç¨å¾®é€æ˜ä¸€ç‚¹
					this.material.opacity = (progress > 0.8 || progress < 0.1) ? 0.6 : 0.9;
				}
			}
		};

		// ==========================================
		//    æ ¸å¿ƒæ›¿æ¢å‡½æ•°ï¼šcreatePlayerModel
		// ==========================================

		function createPlayerModel() {
			if (player) scene.remove(player); // æ¸…é™¤æ—§æ¨¡å‹

			// è·å–å½“å‰é€‰æ‹©çš„è§’è‰²ID
			const charId = GameData.curChar || 'default';
			const charData = CHARACTERS[charId];

			// æ ¹æ®IDè°ƒç”¨ä¸åŒçš„æ„å»ºå·¥å‚
			let newPlayer;
			switch (charId) {
				case 'crimson':
					newPlayer = CharacterFactory.buildCrimson(charData.color, charData.glow);
					break;
				case 'stealth':
					newPlayer = CharacterFactory.buildStealth(charData.color, charData.glow);
					break;
				case 'golden':
					newPlayer = CharacterFactory.buildGolden(charData.color, charData.glow);
					break;
				default:
					newPlayer = CharacterFactory.buildDefault(charData.color, charData.glow);
					break;
			}

			// --- é€šç”¨é…ä»¶ï¼šå–·æ°”èƒŒåŒ… (Jetpack) ---
			// æ‰€æœ‰è§’è‰²å…±ç”¨è¿™å¥—é€»è¾‘ï¼ŒæŒ‚è½½åœ¨èƒŒéƒ¨
			const pack = new THREE.Group();
			const packBody = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.5, 0.2), Materials.dark);
			pack.add(packBody);

			// å–·å£
			const nozzleGeo = new THREE.CylinderGeometry(0.06, 0.1, 0.2, 8);
			const nozzleL = new THREE.Mesh(nozzleGeo, Materials.dark); nozzleL.position.set(-0.12, -0.3, 0);
			const nozzleR = new THREE.Mesh(nozzleGeo, Materials.dark); nozzleR.position.set(0.12, -0.3, 0);
			pack.add(nozzleL, nozzleR);

			// ç«ç„°ç²’å­ (é¢„åˆ›å»º)
			const flameGeo = new THREE.ConeGeometry(0.12, 0.8, 8);
			flameGeo.translate(0, 0.4, 0);
			const matFire = new THREE.MeshBasicMaterial({ color: 0xFF6600 });
			const flameL = new THREE.Mesh(flameGeo, matFire);
			flameL.rotation.x = Math.PI; flameL.position.set(-0.12, -0.4, 0);
			const flameR = new THREE.Mesh(flameGeo, matFire);
			flameR.rotation.x = Math.PI; flameR.position.set(0.12, -0.4, 0);
			pack.add(flameL, flameR);

			pack.position.set(0, 1.0, -0.25); // æŒ‚åœ¨èƒŒéƒ¨
			pack.visible = false; // é»˜è®¤éšè—

			// å°†èƒŒåŒ…ç»„ä»¶æ³¨å…¥åˆ° newPlayer çš„ userData ä¸­ï¼Œä¿è¯åŸæœ‰é€»è¾‘ä¸æŠ¥é”™
			newPlayer.add(pack);
			newPlayer.userData.pack = pack;
			newPlayer.userData.flames = [flameL, flameR];

			// é˜´å½±è®¾ç½®
			newPlayer.traverse(obj => { if (obj.isMesh) obj.castShadow = true; });

			player = newPlayer;
			scene.add(player);
		}

		function createMagnetModel() {
			const group = new THREE.Group();
			const matRed = new THREE.MeshPhongMaterial({ color: 0xE74C3C });
			const matSilver = new THREE.MeshPhongMaterial({ color: 0xBDC3C7 });
			const bottom = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.15, 0.15), matRed); bottom.position.y = -0.25;
			const left = new THREE.Mesh(new THREE.BoxGeometry(0.15, 0.4, 0.15), matRed); left.position.set(-0.225, 0, 0);
			const right = new THREE.Mesh(new THREE.BoxGeometry(0.15, 0.4, 0.15), matRed); right.position.set(0.225, 0, 0);
			const tipL = new THREE.Mesh(new THREE.BoxGeometry(0.16, 0.15, 0.16), matSilver); tipL.position.set(-0.225, 0.25, 0);
			const tipR = new THREE.Mesh(new THREE.BoxGeometry(0.16, 0.15, 0.16), matSilver); tipR.position.set(0.225, 0.25, 0);
			group.add(bottom, left, right, tipL, tipR);
			const wrapper = new THREE.Group(); wrapper.add(group);
			wrapper.scale.set(1.5, 1.5, 1.5); wrapper.userData = { type: 'MAGNET', rotate: true };
			return wrapper;
		}

		function createJetpackModel() {
			const group = new THREE.Group();
			const matTank = new THREE.MeshPhongMaterial({ color: 0x95a5a6, shininess: 80 });
			const matDetail = new THREE.MeshLambertMaterial({ color: 0xf1c40f });
			const tankGeo = new THREE.CylinderGeometry(0.15, 0.15, 0.6, 12);
			const tankL = new THREE.Mesh(tankGeo, matTank); tankL.position.x = -0.2;
			const tankR = new THREE.Mesh(tankGeo, matTank); tankR.position.x = 0.2;
			const belt = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.1, 0.15), matDetail);
			group.add(tankL, tankR, belt);
			const wrapper = new THREE.Group(); wrapper.add(group);
			wrapper.scale.set(1.5, 1.5, 1.5); wrapper.userData = { type: 'JETPACK', rotate: true };
			return wrapper;
		}

		// ==========================================
		// ğŸ”¥ğŸ”¥ğŸ”¥ æ–°å¢ï¼šç§‘å¹»æ˜Ÿçƒç”Ÿæˆå™¨ ğŸ”¥ğŸ”¥ğŸ”¥
		// ==========================================

		// 1. åˆ›å»ºæ™®é€šä½å¤šè¾¹å½¢æ˜Ÿçƒ
		function createPolyPlanet(radius, color, x, y, zOffset) {
			const geo = new THREE.IcosahedronGeometry(radius, 1);
			const mat = new THREE.MeshStandardMaterial({
				color: color, roughness: 0.9, metalness: 0.1, flatShading: true,
				fog: false
			});
			const mesh = new THREE.Mesh(geo, mat);

			// ğŸ”¥ğŸ”¥ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šå‡ºç”Ÿæ—¶ç«‹åˆ»è®¾ç½®æ­£ç¡®ä½ç½® ğŸ”¥ğŸ”¥ğŸ”¥
			// å‡è®¾ç©å®¶åˆå§‹ Z=0
			mesh.position.set(x, y, zOffset);

			// å­˜å‚¨ç›¸å¯¹åç§»é‡
			mesh.userData.offset = { x: x, y: y, z: zOffset };

			mesh.rotation.set(Math.random(), Math.random(), Math.random());
			mesh.userData.rotSpeed = {
				x: (Math.random() - 0.5) * 0.02,
				y: (Math.random() - 0.5) * 0.05,
				z: (Math.random() - 0.5) * 0.02
			};

			scene.add(mesh);
			sciFiElements.push(mesh);
			return mesh;
		}

		// 2. åˆ›å»ºå¸¦å…‰ç¯çš„æ˜Ÿçƒ (åœŸæ˜Ÿé£æ ¼)
		function createRingedPlanet(radius, color, ringColor, x, y, zOffset) {
			const group = new THREE.Group();

			// æœ¬ä½“
			const planetGeo = new THREE.IcosahedronGeometry(radius, 1);
			const planetMat = new THREE.MeshStandardMaterial({
				color: color, roughness: 0.9, metalness: 0.1, flatShading: true,
				fog: false
			});
			const planet = new THREE.Mesh(planetGeo, planetMat);
			group.add(planet);

			// å…‰ç¯
			const ringGeo = new THREE.RingGeometry(radius * 1.4, radius * 2.5, 32);
			const ringMat = new THREE.MeshStandardMaterial({
				color: ringColor, roughness: 0.8, metalness: 0.2,
				side: THREE.DoubleSide, transparent: true, opacity: 0.8,
				fog: false
			});
			const ring = new THREE.Mesh(ringGeo, ringMat);
			ring.rotation.x = Math.PI / 2;
			ring.rotation.y = -0.3;
			group.add(ring);

			// ğŸ”¥ğŸ”¥ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šå‡ºç”Ÿæ—¶ç«‹åˆ»è®¾ç½®æ­£ç¡®ä½ç½® ğŸ”¥ğŸ”¥ğŸ”¥
			group.position.set(x, y, zOffset);

			// å­˜å‚¨ç›¸å¯¹åç§»é‡
			group.userData.offset = { x: x, y: y, z: zOffset };

			group.rotation.z = 0.4;
			planet.userData.rotSpeed = { x: 0, y: 0.02, z: 0 };

			group.userData.isGroup = true;
			sciFiElements.push(group);

			scene.add(group);
			return group;
		}

		// å…¨å±€å˜é‡å¢åŠ ä¸€ä¸ª hemiLight ç”¨äºæ˜¼å¤œå¾ªç¯
		let hemiLight;

		function createEnvironment() {
			// 1. åœºæ™¯åŸºç¡€è®¾ç½®
			// å¼€å¯è½¯é˜´å½±
			renderer.shadowMap.enabled = true;
			renderer.shadowMap.type = THREE.PCFSoftShadowMap;
			renderer.outputEncoding = THREE.sRGBEncoding; // å¼€å¯sRGBï¼Œé¢œè‰²æ›´å‡†ç¡®é²œè‰³

			// 2. ç¯å¢ƒå…‰ç…§ (HemisphereLight)
			// æ¨¡æ‹Ÿå¤©ç©ºå…‰(è“è‰²)å’Œåœ°é¢åå°„å…‰(æš–è‰²)çš„æ··åˆï¼Œæ¯” AmbientLight æ›´çœŸå®
			hemiLight = new THREE.HemisphereLight(0xffffff, 0xffffff, 0.6);
			hemiLight.color.setHSL(0.6, 1, 0.6); // å¤©å…‰åè“
			hemiLight.groundColor.setHSL(0.095, 1, 0.75); // åœ°å…‰åæš–ç™½
			hemiLight.position.set(0, 50, 0);
			scene.add(hemiLight);

			// 3. ä¸»å…‰æº (æ¨¡æ‹Ÿå¤ªé˜³ - äº§ç”ŸæŠ•å½±)
			dirLight = new THREE.DirectionalLight(0xffffff, 1.2); // å¼ºåº¦ 1.2
			dirLight.position.set(-20, 50, -20); // é˜³å…‰ä»å·¦ä¸Šæ–¹æ‰“ä¸‹æ¥
			dirLight.castShadow = true;

			// ä¼˜åŒ–æŠ•å½±å‚æ•°ï¼šä¿è¯è·‘é“èŒƒå›´å†…çš„é˜´å½±æ¸…æ™°
			const d = 30;
			dirLight.shadow.camera.left = -d;
			dirLight.shadow.camera.right = d;
			dirLight.shadow.camera.top = d;
			dirLight.shadow.camera.bottom = -d;

			dirLight.shadow.camera.near = 0.1;
			dirLight.shadow.camera.far = 200;

			// æé«˜é˜´å½±åˆ†è¾¨ç‡ (å¦‚æœå¡é¡¿å¯æ”¹ä¸º 1024)
			dirLight.shadow.mapSize.width = 2048;
			dirLight.shadow.mapSize.height = 2048;

			// è§£å†³é˜´å½±æ¡çº¹(acne)é—®é¢˜
			dirLight.shadow.bias = -0.0001;

			scene.add(dirLight);

			// 4. å¤ªé˜³æœ¬ä½“ (è£…é¥°ç”¨)
			sunMesh = new THREE.Mesh(
				new THREE.SphereGeometry(20, 32, 32),
				new THREE.MeshBasicMaterial({ color: 0xFFAA00 }) // é»„è‰²å¤ªé˜³
			);
			sunMesh.position.set(-20, 60, -100);
			scene.add(sunMesh);

			// =========================================
			// ğŸ”¥ğŸ”¥ğŸ”¥ æ–°å¢ï¼šæ”¾ç½®ç§‘å¹»æ˜Ÿçƒ ğŸ”¥ğŸ”¥ğŸ”¥
			// =========================================

			// æ¸…ç©ºæ—§æ•°æ® (é˜²æ­¢ restart æ—¶é‡å¤æ·»åŠ )
			sciFiElements.forEach(el => scene.remove(el.parent || el));

			// 5. åˆå§‹åŒ–è·‘é“
			for (let i = 0; i < 4; i++) createTrackSegment(-i * CONFIG.TRACK_LENGTH);

			// æ¸…ç©ºæ—§æ•°æ®
			sciFiElements = []; // ç›´æ¥æ¸…ç©ºæ•°ç»„å³å¯ï¼Œscene.removeåœ¨startGameé‡Œåšäº†

			// A. å·¨å¤§çš„åœŸæ˜Ÿ (æ”¾åœ¨å³å‰æ–¹)
			// ä¿®æ”¹ï¼šYä» 100 é™åˆ° 30ï¼ŒZOffset è®¾ä¸º -250
			createRingedPlanet(15, 0x8e44ad, 0x00FFFF, 60, 30, -250);

			// B. çº¢è‰²æ˜Ÿçƒ (æ”¾åœ¨å·¦å‰æ–¹)
			// ä¿®æ”¹ï¼šYä» 150 é™åˆ° 40ï¼ŒZOffset è®¾ä¸º -180 (ç¨å¾®è¿‘ä¸€ç‚¹)
			createPolyPlanet(10, 0xe74c3c, -80, 40, -180);

			// C. è“è‰²å°å«æ˜Ÿ (ä½ç©º)
			// ä¿®æ”¹ï¼šY è®¾ä¸º 25
			createPolyPlanet(6, 0x3498db, 30, 25, -300);
		}

		function createTrackSegment(zPos) {
			const seg = new THREE.Group();

			// 1. åœ°é¢ (ä¿æŒä¸å˜)
			const floorMat = new THREE.MeshStandardMaterial({
				color: CONFIG.COLORS.ground,
				roughness: 1.0,
				metalness: 0.0
			});
			const floor = new THREE.Mesh(new THREE.PlaneGeometry(60, CONFIG.TRACK_LENGTH), floorMat);
			floor.rotation.x = -Math.PI / 2;
			floor.receiveShadow = true;
			seg.add(floor);

			// --- è½¨é“ç³»ç»Ÿæè´¨å®šä¹‰ ---

			// A. é“è½¨ (é‡‘å±è´¨æ„Ÿï¼Œç¨å¾®äº®ä¸€ç‚¹)
			const railGeo = new THREE.BoxGeometry(0.2, 0.3, CONFIG.TRACK_LENGTH); // é«˜åº¦0.3ï¼Œå‡¸å‡ºåœ°é¢
			const railMat = new THREE.MeshStandardMaterial({
				color: 0x999999, // æµ…ç°è‰²é’¢æ
				roughness: 0.4,
				metalness: 0.8   // å¼ºé‡‘å±æ„Ÿ
			});

			// B. æ•æœ¨ (æ·±è‰²æœ¨å¤´è´¨æ„Ÿ)
			// å®½åº¦3.0 (æ¨ªè·¨ä¸¤è½¨)ï¼Œé«˜åº¦0.15 (æ‰å¹³)ï¼Œæ·±åº¦0.6 (å®½æ¿)
			const sleeperGeo = new THREE.BoxGeometry(3.2, 0.15, 0.8);
			const sleeperMat = new THREE.MeshStandardMaterial({
				color: 0x4e342e, // æ·±è¤è‰²
				roughness: 0.9,  // ç²—ç³™æœ¨å¤´
				metalness: 0.0
			});

			CONFIG.LANES.forEach(x => {
				// --- 1. é“ºè®¾é“è½¨ (ä¿®æ­£ä¸ºå®Œç¾å¯¹ç§°) ---
				// ä¹‹å‰æ˜¯ -1.0 å’Œ +1.6ï¼Œçœ‹èµ·æ¥æ˜¯æ­ªçš„ã€‚ç°åœ¨æ”¹ä¸ºè·ç¦»ä¸­å¿ƒ Â±1.2
				const railOffset = 1.2;

				let r1 = new THREE.Mesh(railGeo, railMat);
				r1.position.set(x - railOffset, 0.15, 0); // Y=0.15 ç¡®ä¿åº•éƒ¨è´´åœ°
				r1.castShadow = true; // é“è½¨æŠ•å°„ç»†å¾®é˜´å½±
				r1.receiveShadow = true;
				seg.add(r1);

				let r2 = new THREE.Mesh(railGeo, railMat);
				r2.position.set(x + railOffset, 0.15, 0);
				r2.castShadow = true;
				r2.receiveShadow = true;
				seg.add(r2);

				// --- 2. é“ºè®¾æ•æœ¨ (å…³é”®å¾ªç¯) ---
				// æ¯éš” 4 ç±³é“ºè®¾ä¸€æ ¹æ•æœ¨
				const spacing = 4.0;

				for (let z = -CONFIG.TRACK_LENGTH / 2; z < CONFIG.TRACK_LENGTH / 2; z += spacing) {
					const sleeper = new THREE.Mesh(sleeperGeo, sleeperMat);

					// ä½ç½®ï¼šX=è½¦é“ä¸­å¿ƒ, Y=0.05(æ¯”åœ°é¢ç•¥é«˜, æ¯”é“è½¨ä½), Z=å¾ªç¯ä½ç½®
					sleeper.position.set(x, 0.08, z);
					sleeper.receiveShadow = true; // æ•æœ¨æ¥æ”¶é“è½¨çš„é˜´å½±

					seg.add(sleeper);
				}
			});

			seg.position.z = zPos;
			scene.add(seg);
			activeTracks.push(seg);
		}

		function spawnBuilding(zPos) {
			const h1 = 15 + Math.random() * 30; const w1 = 5 + Math.random() * 5; const d1 = 5 + Math.random() * 5;
			const mat1 = buildingMaterials[Math.floor(Math.random() * buildingMaterials.length)];
			const b1 = new THREE.Mesh(new THREE.BoxGeometry(w1, h1, d1), mat1);
			b1.position.set(-12 - (w1 / 2), h1 / 2 - 5, zPos); b1.castShadow = true; b1.receiveShadow = true;
			scene.add(b1); activeDecorations.push(b1);

			const h2 = 15 + Math.random() * 30; const w2 = 5 + Math.random() * 5; const d2 = 5 + Math.random() * 5;
			const mat2 = buildingMaterials[Math.floor(Math.random() * buildingMaterials.length)];
			const b2 = new THREE.Mesh(new THREE.BoxGeometry(w2, h2, d2), mat2);
			b2.position.set(12 + (w2 / 2), h2 / 2 - 5, zPos); b2.castShadow = true; b2.receiveShadow = true;
			scene.add(b2); activeDecorations.push(b2);
		}

		function spawnObstacle(zPos) {
			if (jetpackActive) { for (let i = 0; i < 3; i++) spawnCoins(CONFIG.LANES[i], zPos, CONFIG.JETPACK_HEIGHT); }
			const rand = Math.random();
			const laneIdx = Math.floor(Math.random() * 3);
			const laneX = CONFIG.LANES[laneIdx];
			const now = Date.now();

			if (rand < 0.05) {
				const mag = createMagnetModel(); mag.position.set(laneX, 1.0, zPos); scene.add(mag); activeMagnets.push(mag);
			} else if (rand < 0.10) {
				const jet = createJetpackModel(); jet.position.set(laneX, 1.0, zPos); scene.add(jet); activeJetpacks.push(jet);
			} else {
				let mesh;
				const obstacleType = Math.random();
				let canSpawnTrain = (now - world.lastMovingTrainTime) > CONFIG.TRAIN_COOLDOWN;

				if (canSpawnTrain && obstacleType < 0.25) {
					mesh = createTrainModel(true);
					mesh.position.set(laneX, 0, zPos - CONFIG.MOVING_TRAIN_SPAWN_OFFSET);
					world.lastMovingTrainTime = now;
				} else if (obstacleType < 0.6) {
					mesh = createTrainModel(false); mesh.position.set(laneX, 0, zPos);
				} else if (obstacleType < 0.8) {
					const group = new THREE.Group();
					const pole = new THREE.Mesh(new THREE.BoxGeometry(0.2, 3, 0.2), new THREE.MeshLambertMaterial({ color: 0x7F8C8D }));
					const p1 = pole.clone(); p1.position.set(-1.2, 1.5, 0); const p2 = pole.clone(); p2.position.set(1.2, 1.5, 0);
					const bar = new THREE.Mesh(new THREE.BoxGeometry(2.6, 1, 0.2), new THREE.MeshLambertMaterial({ color: 0x27AE60 }));
					bar.position.set(0, 2.5, 0); group.add(p1, p2, bar); group.position.set(laneX, 0, zPos);
					mesh = group; mesh.userData.isHigh = true;
				} else {
					mesh = new THREE.Mesh(new THREE.BoxGeometry(2.2, 0.8, 0.5), new THREE.MeshLambertMaterial({ color: 0xE67E22 }));
					mesh.position.set(laneX, 0.4, zPos);
				}
				if (mesh.isMesh || mesh.isGroup) {
					mesh.traverse(child => { if (child.isMesh) { child.castShadow = true; child.receiveShadow = true; } });
				}
				scene.add(mesh); activeObstacles.push(mesh);
			}

			if (!jetpackActive) { const coinLane = (laneIdx + 1) % 3; spawnCoins(CONFIG.LANES[coinLane], zPos, 0.8); }
			spawnBuilding(zPos);
		}

		function spawnCoins(x, z, height) {
			if (Math.random() > 0.6) return; // åŸºç¡€ç”Ÿæˆæ¦‚ç‡ä¸å˜

			const rand = Math.random();

			// 3% æ¦‚ç‡ç”Ÿæˆ ç´«æ˜Ÿå¸ (ä»·å€¼100)
			if (rand < CONFIG.SPECIAL_COINS.star.chance) {
				const coin = CoinFactory.createStar();
				// ç‰¹æ®Šé‡‘å¸é€šå¸¸æ”¾å¾—ç¨å¾®é«˜ä¸€ç‚¹ï¼Œæˆ–è€…å±…ä¸­
				coin.position.set(x, height + 0.5, z + 3);
				coin.userData.collected = false;
				scene.add(coin);
				activeCoins.push(coin);
				return;
			}

			// 8% æ¦‚ç‡ç”Ÿæˆ è“é’»å¸ (ä»·å€¼50)
			if (rand < CONFIG.SPECIAL_COINS.star.chance + CONFIG.SPECIAL_COINS.gem.chance) {
				const coin = CoinFactory.createGem();
				coin.position.set(x, height + 0.5, z + 3);
				coin.userData.collected = false;
				scene.add(coin);
				activeCoins.push(coin);
				return;
			}

			// å‰©ä¸‹çš„æ¦‚ç‡ç”Ÿæˆ 5ä¸ªæ™®é€šé‡‘å¸ (åŸæœ‰é€»è¾‘)
			for (let i = 0; i < 5; i++) {
				const coin = CoinFactory.createNormal();
				coin.position.set(x, height, z + (i * 1.5));
				coin.userData.collected = false;
				scene.add(coin);
				activeCoins.push(coin);
			}
		}

		function startGame(e) {
			if (e && e.stopPropagation) e.stopPropagation();
			if (document.getElementById('play-btn')) document.getElementById('play-btn').blur();

			// æ’­æ”¾BGM
			AudioSys.init();
			AudioSys.startBGM();

			// é‡ç½®æŠ¤ç›¾çŠ¶æ€
			hasShield = true;       // å¼€å±€è‡ªå¸¦ä¸€æ¬¡æœºä¼š
			isInvincible = false;
			invincibleTimer = 0;

			// ç¡®ä¿ç©å®¶æ¨¡å‹æ˜¯å¯è§çš„
			if (player) player.visible = true;

			// æ¸…ç†åœºæ™¯ç‰©ä½“
			[activeObstacles, activeCoins, activeMagnets, activeJetpacks, activeDecorations].forEach(arr => {
				arr.forEach(o => scene.remove(o)); arr.length = 0;
			});
			activeTracks.forEach(t => scene.remove(t)); activeTracks.length = 0;

			// é‡å»ºè·‘é“å’Œåˆå§‹å»ºç­‘
			for (let i = 0; i < 3; i++) createTrackSegment(-i * CONFIG.TRACK_LENGTH);
			for (let i = 10; i < 150; i += 25) { spawnBuilding(-i); }

			// é‡ç½®ä½ç½®
			player.position.set(0, 0, 0); player.rotation.set(0, 0, 0);
			camera.position.set(0, 5, 8); camera.rotation.set(-0.3, 0, 0);

			// é‡ç½®æ¸¸æˆå‚æ•°
			targetLane = 1; speed = CONFIG.PLAYER_SPEED_BASE;
			score = 0; coins = 0; distance = 0; survivalTime = 0;
			isJumping = false; isSliding = false; verticalVelocity = 0;

			// ğŸ”¥ğŸ”¥ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šä¸è¦é‡ç½®ä¸º 0ï¼Œè€Œæ˜¯é‡ç½®ä¸ºé…ç½®çš„èµ·å§‹æ—¶é—´ï¼ ğŸ”¥ğŸ”¥ğŸ”¥
			cycleTime = CONFIG.CYCLE_DURATION * CONFIG.START_TIME_OFFSET;

			magnetActive = false; magnetTimer = 0;
			jetpackActive = false; jetpackTimer = 0;
			isPaused = false;
			world.lastMovingTrainTime = 0;

			// é‡ç½®çŠ¶æ€æ UI
			document.getElementById('magnet-status').classList.remove('active');
			document.getElementById('jetpack-status').classList.remove('active');

			if (player && player.userData && player.userData.pack) {
				player.userData.pack.visible = false;
			}

			// è‡ªåŠ¨ä½¿ç”¨é“å…·é€»è¾‘
			let autoUsed = false;
			if (GameData.settings.autoJetpack && GameData.inventory.jetpack > 0) {
				GameData.inventory.jetpack--; activateJetpack(); autoUsed = true;
			} else if (GameData.settings.autoMagnet && GameData.inventory.magnet > 0) {
				GameData.inventory.magnet--; activateMagnet(); autoUsed = true;
			}
			if (autoUsed) GameData.save();

			world.lastSpawnZ = 0;
			gameActive = true;

			// æ›´æ–°ä¸€æ¬¡HUDæ•°æ®
			updateHUD();

			// =========================================
			// ğŸ”¥ğŸ”¥ğŸ”¥ æ ¸å¿ƒä¿®å¤åŒºåŸŸ START ğŸ”¥ğŸ”¥ğŸ”¥
			// =========================================

			// 1. éšè—ä¸»èœå•å’Œæ—§ç‰ˆUI
			document.getElementById('main-menu').classList.add('hidden');
			document.getElementById('game-over').classList.add('hidden');

			// 2. å¼ºåˆ¶éšè—æ–°ç‰ˆç»“ç®—ç•Œé¢ (é˜²æ­¢å†æ¬¡å¼€å§‹æ—¶æ²¡å…³æ‰)
			document.getElementById('game-over-screen').style.display = 'none';

			// 3. æ˜¾ç¤ºæš‚åœæŒ‰é’® (æ¸…é™¤ hidden ç±»ï¼Œå¹¶å¼ºåˆ¶è®¾ä¸º block)
			const pauseBtn = document.getElementById('pause-btn');
			pauseBtn.classList.remove('hidden');
			pauseBtn.style.display = 'block';

			// 4. æ˜¾ç¤º HUD é¢æ¿ (æ¸…é™¤ hidden ç±»ï¼Œå¹¶å¼ºåˆ¶è®¾ä¸º flex)
			// ä¹‹å‰å°±æ˜¯è¿™é‡Œå‡ºé—®é¢˜äº†ï¼Œstyle.display='none' æ²¡è¢«æ¸…é™¤
			const hudPanel = document.getElementById('hud-panel');
			hudPanel.classList.remove('hidden');
			hudPanel.style.display = 'flex';

			// =========================================
			// ğŸ”¥ğŸ”¥ğŸ”¥ æ ¸å¿ƒä¿®å¤åŒºåŸŸ END ğŸ”¥ğŸ”¥ğŸ”¥
			// =========================================
		}
		window.startGame = startGame;

		function updateDayNightCycle(delta) {
			cycleTime += delta;
			const progress = (cycleTime % CONFIG.CYCLE_DURATION) / CONFIG.CYCLE_DURATION;

			let skyColor, sunColor = 0xFFFFFF;
			let lightIntensity = 1.0;
			let hemiIntensity = 0.6;

			// ç®€åŒ–å¾ªç¯ï¼šå¤§éƒ¨åˆ†æ—¶é—´æ˜¯æ˜äº®çš„ç™½å¤©
			if (progress < 0.15) {
				// æ—¥å‡º
				const t = progress / 0.15;
				skyColor = new THREE.Color(CONFIG.COLORS.skyNight).lerp(new THREE.Color(CONFIG.COLORS.skySunrise), t);
				lightIntensity = 0.2 + t * 0.8;
			} else if (progress < 0.25) {
				// æ—©ä¸Š (è¿‡æ¸¡åˆ°æ­£åˆè“)
				const t = (progress - 0.15) / 0.1;
				skyColor = new THREE.Color(CONFIG.COLORS.skySunrise).lerp(new THREE.Color(CONFIG.COLORS.skyDay), t);
			} else if (progress < 0.75) {
				// æ­£åˆ (è¶…é•¿å¾…æœº) - ä¿æŒæ¹›è“
				skyColor = new THREE.Color(CONFIG.COLORS.skyDay);
				sunColor = 0xFFFFAA;
				lightIntensity = 1.2;
			} else if (progress < 0.85) {
				// æ—¥è½
				const t = (progress - 0.75) / 0.1;
				skyColor = new THREE.Color(CONFIG.COLORS.skyDay).lerp(new THREE.Color(CONFIG.COLORS.skySunset), t);
				lightIntensity = 1.2 - t * 0.8;
				sunColor = 0xFFAA00;
			} else {
				// å¤œæ™š
				const t = (progress - 0.85) / 0.15;
				skyColor = new THREE.Color(CONFIG.COLORS.skySunset).lerp(new THREE.Color(CONFIG.COLORS.skyNight), t);
				lightIntensity = 0.2;
				sunColor = 0x000000; // æ™šä¸Šå¤ªé˜³é»‘æ‰
			}

			// æ›´æ–°å¤©ç©ºå’Œé›¾
			scene.background = skyColor;
			scene.fog.color = skyColor;

			// åŠ¨æ€è°ƒæ•´é›¾çš„æµ“åº¦ï¼šæ™šä¸Šé›¾å¤§ä¸€ç‚¹ï¼Œç™½å¤©é›¾è¿œä¸€ç‚¹
			const targetFogNear = (progress > 0.85 || progress < 0.15) ? 20 : CONFIG.FOG.near;
			const targetFogFar = (progress > 0.85 || progress < 0.15) ? 100 : CONFIG.FOG.far;

			// ç®€å•çš„çº¿æ€§è¿‡æ¸¡
			scene.fog.near += (targetFogNear - scene.fog.near) * 0.05;
			scene.fog.far += (targetFogFar - scene.fog.far) * 0.05;

			// æ›´æ–°å…‰ç…§
			dirLight.intensity = lightIntensity;
			dirLight.color.setHex(sunColor);

			if (hemiLight) {
				// åŠçƒå…‰éšå¤©ç©ºé¢œè‰²å¾®è°ƒ
				hemiLight.color.copy(skyColor).lerp(new THREE.Color(0xffffff), 0.5);
				hemiLight.intensity = lightIntensity * 0.6;
			}

			// æ›´æ–°äº‘å±‚
			CloudSystem.updateColor(progress);

			// å¤ªé˜³ä½ç½®
			const angle = progress * Math.PI * 2;
			// åªæœ‰Yè½´è¿åŠ¨ï¼Œä¿æŒå…‰ç…§æ–¹å‘å¤§ä½“ä¸€è‡´ï¼Œåªæ”¹å˜é«˜åº¦
			sunMesh.position.y = Math.sin(angle) * 100;
			sunMesh.position.x = Math.cos(angle) * 100;
			sunMesh.material.color.setHex(sunColor);
		}

		function animate() {
			requestAnimationFrame(animate);
			const delta = clock.getDelta();

			if (gameActive) {
				if (!isPaused) {
					updateDayNightCycle(delta);

					// 1. äº‘å±‚æ›´æ–°
					CloudSystem.update(delta, player.position.z);

					// 2. ç‰¹æ•ˆæ›´æ–°
					VFX.update(delta);

					// =========================================
					// ğŸ”¥ğŸ”¥ğŸ”¥ æ–°å¢ï¼šæ›´æ–°æ˜Ÿçƒè‡ªè½¬ ğŸ”¥ğŸ”¥ğŸ”¥
					// =========================================
					sciFiElements.forEach(el => {
						// 1. è·Ÿéšç©å®¶ç§»åŠ¨ (åˆ¶é€ å¤©ç©ºç›’æ•ˆæœ)
						if (el.userData.offset) {
							el.position.x = el.userData.offset.x; // X ä¿æŒç›¸å¯¹é™æ­¢
							el.position.y = el.userData.offset.y; // Y ä¿æŒç›¸å¯¹é™æ­¢

							// ğŸ”¥ å…³é”®ï¼šZè½´é”å®šåœ¨ç©å®¶å‰æ–¹å›ºå®šè·ç¦»
							el.position.z = player.position.z + el.userData.offset.z;
						}

						// 2. è‡ªè½¬é€»è¾‘ (åªé’ˆå¯¹æœ‰ rotSpeed çš„ç‰©ä½“ï¼Œé€šå¸¸æ˜¯ Mesh)
						if (el.userData.rotSpeed) {
							el.rotation.x += el.userData.rotSpeed.x * delta;
							el.rotation.y += el.userData.rotSpeed.y * delta;
							el.rotation.z += el.userData.rotSpeed.z * delta;
						}
					});

					// 3. æ— æ•Œé—ªçƒé€»è¾‘
					if (isInvincible) {
						invincibleTimer -= delta;
						const blinkSpeed = 100;
						player.visible = Math.floor(Date.now() / blinkSpeed) % 2 === 0;
						if (invincibleTimer <= 0) {
							isInvincible = false;
							player.visible = true;
						}
					} else {
						if (!player.visible) player.visible = true;
					}

					// 4. ç§»åŠ¨è·ç¦»è®¡ç®—
					const moveDist = speed * delta;
					player.position.z -= moveDist;
					distance += moveDist;

					if (speed < CONFIG.PLAYER_SPEED_MAX) { speed += CONFIG.SPEED_ACCELERATION * delta; }

					const tx = CONFIG.LANES[targetLane];
					player.position.x += (tx - player.position.x) * 10 * delta;

					// 5. éšœç¢ç‰©ç§»åŠ¨ (ç«è½¦)
					activeObstacles.forEach(obs => {
						if (obs.userData.isMovingTrain) {
							obs.position.z += obs.userData.trainSpeed * delta;
						}
					});

					// =========================================
					// æ ¸å¿ƒä¿®å¤ï¼šç›¸æœºä¸åœ°é¢æ£€æµ‹é€»è¾‘
					// =========================================

					// A. å…ˆæ£€æµ‹åœ°é¢ (è¿™ä¼šæ›´æ–°å…¨å±€å˜é‡ currentGroundY)
					checkGroundStatus();

					// B. åŸºäºåœ°é¢è®¡ç®—ç›¸æœºç›®æ ‡ (å…³é”®ç‚¹ï¼šè¿™é‡Œå¿…é¡»åŠ¨æ€è®¡ç®—!)
					// å¦‚æœåœ¨åœ°é¢(0)ï¼ŒtargetY = 5; å¦‚æœåœ¨è½¦é¡¶(4)ï¼ŒtargetY = 9
					let targetY = currentGroundY + 5;
					let targetZOffset = 8;
					let targetRotX = -0.1;

					// C. å–·æ°”èƒŒåŒ…é€»è¾‘ (å¦‚æœæœ‰ï¼Œå¼ºåˆ¶è¦†ç›–ç›¸æœºå‚æ•°)
					if (jetpackActive) {
						jetpackTimer -= delta;
						document.getElementById('jetpack-timer').innerText = jetpackTimer.toFixed(1) + 's';
						if (jetpackTimer <= 0) {
							jetpackActive = false;
							document.getElementById('jetpack-status').classList.remove('active');
						}

						player.userData.pack.visible = true;
						const hoverWave = Math.sin(Date.now() * 0.005) * 0.3;
						const targetH = CONFIG.JETPACK_HEIGHT + hoverWave;
						player.position.y += (targetH - player.position.y) * 5 * delta;

						// å¼ºåˆ¶è¦†ç›–ç›¸æœºé«˜åº¦
						targetY = 12;
						targetZOffset = 14;
						targetRotX = -0.45;

						player.rotation.x = 0.2; player.rotation.z = -(tx - player.position.x) * 0.15;
						player.userData.flames.forEach(f => {
							f.visible = true; const pulse = 1.5 + Math.sin(Date.now() * 0.02) * 0.5;
							f.scale.set(pulse, pulse * 1.2, pulse);
						});
						player.userData.lLeg.position.z = -0.1; player.userData.rLeg.position.z = -0.1;
						player.userData.lLeg.rotation.x = -0.2 + hoverWave * 0.2; player.userData.rLeg.rotation.x = -0.2 + hoverWave * 0.2;
						player.userData.lArm.rotation.x = -0.5; player.userData.rArm.rotation.x = -0.5;
						isJumping = false; isSliding = false;

					} else {
						// æ™®é€šçŠ¶æ€é€»è¾‘
						player.userData.pack.visible = false;
						player.rotation.x = 0; player.rotation.z = -(tx - player.position.x) * 0.15;

						if (isJumping) {
							player.position.y += verticalVelocity;
							verticalVelocity -= CONFIG.GRAVITY;

							// è½åœ°åˆ¤å®šï¼šä½¿ç”¨ currentGroundY
							if (player.position.y <= currentGroundY) {
								player.position.y = currentGroundY;
								isJumping = false;
								verticalVelocity = 0;
							}
						} else {
							// è·‘åŠ¨ä¸­ï¼šå¤„ç†ä¸‹è½
							if (player.position.y > currentGroundY) {
								player.position.y -= CONFIG.GRAVITY * 15;
								if (player.position.y < currentGroundY) player.position.y = currentGroundY;
							} else if (player.position.y < currentGroundY) {
								player.position.y = currentGroundY;
							}
						}

						if (isSliding) {
							slideTimer -= delta; player.scale.y = 0.5;
							if (slideTimer <= 0) { isSliding = false; player.scale.y = 1; }
						}

						if (!isJumping && !isSliding) {
							const time = Date.now() * 0.015;
							player.userData.lLeg.rotation.x = 0; player.userData.rLeg.rotation.x = 0;
							player.userData.lLeg.position.z = Math.sin(time) * 0.2; player.userData.rLeg.position.z = Math.cos(time) * 0.2;
							player.userData.lArm.rotation.x = Math.cos(time) * 0.5; player.userData.rArm.rotation.x = Math.sin(time) * 0.5;
						}
					}

					// 6. ç£é“ä¸é‡‘å¸é€»è¾‘ (ä½ çš„ç‰ˆæœ¬é‡Œæœ‰ï¼Œä¿æŒä¸å˜)
					if (magnetActive) {
						magnetTimer -= delta;
						document.getElementById('magnet-timer').innerText = magnetTimer.toFixed(1) + 's';
						if (magnetTimer <= 0) {
							magnetActive = false;
							document.getElementById('magnet-status').classList.remove('active');
						}
						activeCoins.forEach(coin => {
							if (coin.position.distanceTo(player.position) < CONFIG.MAGNET_RANGE && !coin.userData.collected) {
								coin.userData.attracted = true;
							}
							if (coin.userData.attracted) {
								const target = player.position.clone().add(new THREE.Vector3(0, 1, 0));
								const flySpeed = Math.max(50, speed * 2.5);
								const direction = target.clone().sub(coin.position).normalize();
								const moveStep = flySpeed * delta;
								coin.position.add(direction.multiplyScalar(moveStep));
								const dist = coin.position.distanceTo(target);
								if (dist < 1.5 || dist < moveStep) collectCoin(coin);
							}
						});
					}

					updateWorldGen();
					checkTrainInteractions();
					checkCollisions();

					score = Math.floor(distance * 10) + (coins * 50);
					survivalTime += delta;
					updateHUD();

					// =========================================
					// D. åº”ç”¨ç›¸æœºä½ç½® (æ­¤æ—¶ targetY ç»å¯¹æ˜¯æ­£ç¡®çš„)
					// =========================================
					camera.position.y += (targetY - camera.position.y) * 3 * delta;
					const desiredZ = player.position.z + targetZOffset;
					camera.position.z += (desiredZ - camera.position.z) * 5 * delta;
					camera.position.x = player.position.x * 0.4;
					camera.rotation.x += (targetRotX - camera.rotation.x) * 3 * delta;
				}
			} else {
				// æ¸¸æˆç»“æŸæ—¶çš„ç©ºè½¬é•œå¤´
				const t = Date.now() * 0.002;
				player.position.y = Math.sin(t) * 0.1;
				player.rotation.y += 0.01;
			}
			renderer.render(scene, camera);
		}

		function checkGroundStatus() {
			// é»˜è®¤åœ°é¢æ˜¯ 0
			let newGroundY = 0;
			onTrain = false; // é‡ç½®çŠ¶æ€

			// è·å–ç©å®¶å½“å‰çš„ä¸­å¿ƒç‚¹
			const pBox = new THREE.Box3().setFromObject(player);
			const center = new THREE.Vector3();
			pBox.getCenter(center);

			// åªæ£€æµ‹è„šä¸‹çš„æ ¸å¿ƒåŒºåŸŸ
			const footCheckX = center.x;
			const footCheckZ = center.z;

			// éå†æ‰€æœ‰éšœç¢ç‰©
			for (let obs of activeObstacles) {

				// === ä¿®å¤çš„æ ¸å¿ƒç‚¹ START ===
				// åˆ¤å®šæ˜¯å¦ä¸ºç«è½¦ï¼š
				// 1. å®ƒæ˜¯ç§»åŠ¨ç«è½¦ (isMovingTrain)
				// 2. æˆ–è€…å®ƒæ˜¯éšœç¢ç‰©ä¸”è™½ç„¶Yæ˜¯0ä½†åŒ…å›´ç›’å¾ˆé«˜ (BoxMaxY > 2)
				// ä¸ºäº†ç®€å•ç¨³å®šï¼Œæˆ‘ä»¬ç›´æ¥æ£€æŸ¥ userData é‡Œçš„æ ‡è®°
				const isTrain = obs.userData.isMovingTrain === true || (obs.userData.isObstacle === true && !obs.userData.isHigh);
				// === ä¿®å¤çš„æ ¸å¿ƒç‚¹ END ===

				if (isTrain) {
					const obsBox = new THREE.Box3().setFromObject(obs);

					// æ‰©å±•ä¸€ä¸‹åˆ¤å®šèŒƒå›´ï¼Œè®©ä¸Šè½¦ç¨å¾®å®¹æ˜“ä¸€ç‚¹ç‚¹
					obsBox.expandByScalar(0.2);

					// æ ¸å¿ƒåˆ¤å®šï¼šç©å®¶åœ¨ç«è½¦çš„ X/Z å¹³é¢èŒƒå›´å†…
					if (footCheckX >= obsBox.min.x && footCheckX <= obsBox.max.x &&
						footCheckZ >= obsBox.min.z && footCheckZ <= obsBox.max.z) {

						// ç«è½¦é¡¶éƒ¨é«˜åº¦å›ºå®šä¸º 4.0
						const trainTopY = 4.0;

						// å¦‚æœæˆ‘ä»¬å·²ç»åœ¨è½¦é¡¶é™„è¿‘ (åŠ ä¸€ç‚¹å®¹å·®ï¼Œé˜²æ­¢æ‰ä¸‹å»)
						// åªè¦è„šåº•æ¿é«˜åº¦ > 3.0 å°±è®¤ä¸ºåœ¨è½¦é¡¶èŒƒå›´
						if (player.position.y >= 3.0) {
							newGroundY = trainTopY;
							onTrain = true;
							break; // æ‰¾åˆ°äº†æ”¯æ’‘ç‚¹
						}
					}
				}
			}

			// æ›´æ–°å…¨å±€å˜é‡
			currentGroundY = newGroundY;
		}

		function checkCollisions() {
			// è·å–ç©å®¶åŒ…å›´ç›’
			const pBox = new THREE.Box3().setFromObject(player);
			// ç¨å¾®ç¼©å°åˆ¤å®šèŒƒå›´
			pBox.min.x += 0.3; pBox.max.x -= 0.3;
			pBox.min.z += 0.2; pBox.max.z -= 0.2;

			const playerBottomY = player.position.y;

			// --- 1. éšœç¢ç‰©æ£€æµ‹ ---
			if (!jetpackActive) {
				for (let i = activeObstacles.length - 1; i >= 0; i--) {
					const obs = activeObstacles[i];
					const obsBox = new THREE.Box3().setFromObject(obs);

					// ç¢°æ’å‘ç”Ÿï¼
					if (pBox.intersectsBox(obsBox)) {

						// A. æ»‘é“²ç©¿è¿‡é«˜æ¶è·¯éšœ (ä¿æŒä¸å˜)
						if (isSliding && obs.userData.isHigh) continue;

						// B. ç«è½¦ç¢°æ’é€»è¾‘ (æ ¸å¿ƒä¿®å¤)
						const isHeavy = obs.userData.isObstacle === true;

						if (isHeavy) {
							// ç«è½¦é¡¶éƒ¨é«˜åº¦
							const trainTopY = 4.0;
							// åˆ¤å®šé˜ˆå€¼ï¼šåªè¦ç©å®¶è„šåº•åœ¨ç«è½¦â€œè…°éƒ¨â€ä»¥ä¸Šï¼Œå°±ç®—å®‰å…¨åŒºåŸŸ
							const toleranceThreshold = 2.5;

							if (playerBottomY > toleranceThreshold) {
								// ğŸ”¥ğŸ”¥ğŸ”¥ æ ¸å¿ƒä¿®å¤é€»è¾‘ ğŸ”¥ğŸ”¥ğŸ”¥

								// æƒ…å†µ1ï¼šä¸‹è½æˆ–è·‘åŠ¨ä¸­ -> å¸é™„åˆ°è½¦é¡¶
								if (verticalVelocity <= 0) {
									player.position.y = trainTopY;
									verticalVelocity = 0;
									isJumping = false;
									onTrain = true;
									currentGroundY = trainTopY;
								}

								// æƒ…å†µ2ï¼šæ­£åœ¨å‘ä¸Šèµ·è·³ (verticalVelocity > 0)
								// æ­¤æ—¶æˆ‘ä»¬ä»€ä¹ˆéƒ½ä¸åšï¼Œç›´æ¥ continueã€‚
								// æ„æ€æ˜¯ï¼š"è™½ç„¶åˆ¤å®šç›’æ¥è§¦äº†ï¼Œä½†ç©å®¶åœ¨ä¸Šé¢é£ï¼Œåˆ«æ€ä»–ï¼Œè®©ä»–é£ã€‚"

								continue; // è·³è¿‡æ­»äº¡åˆ¤å®š
							}

							// å¦‚æœé«˜åº¦ä¸å¤Ÿ(æ’åˆ°äº†è½¦å¤´æˆ–ä¾§é¢)ï¼Œé‚£å°±çœŸçš„æ­»å®šäº†
							gameOver();
							return;
						} else {
							// C. æ’å°éšœç¢ (ä¿æŒä¸å˜)
							if (isInvincible) {
								smashObstacle(obs, i);
							} else if (hasShield) {
								activateInvincibility();
								smashObstacle(obs, i);
							} else {
								gameOver();
								return;
							}
						}
					}
				}
			}

			// --- 2. é“å…·æ‹¾å– (ä¿æŒä¸å˜) ---
			const checkItem = (list, action) => {
				for (let i = list.length - 1; i >= 0; i--) {
					const item = list[i]; item.rotation.y += 0.05;
					const iBox = new THREE.Box3().setFromObject(item); iBox.expandByScalar(0.5);
					if (pBox.intersectsBox(iBox)) { action(); scene.remove(item); list.splice(i, 1); }
				}
			};
			checkItem(activeMagnets, activateMagnet);
			checkItem(activeJetpacks, activateJetpack);

			// --- 3. é‡‘å¸æ‹¾å– (ä¿æŒä¸å˜) ---
			for (let i = activeCoins.length - 1; i >= 0; i--) {
				const coin = activeCoins[i];
				if (coin.userData.collected) continue;

				if (coin.userData.type === 'star') {
					coin.rotation.y += 0.02; coin.userData.ring.rotation.x += 0.05; coin.userData.ring.rotation.y += 0.05;
				} else {
					coin.rotation.y += coin.userData.rotateSpeed || 0.1;
				}

				const coinBox = new THREE.Box3().setFromObject(coin);
				if (coin.userData.type !== 'normal') coinBox.expandByScalar(0.2);

				if (pBox.intersectsBox(coinBox)) collectCoin(coin);
			}
		}

		function showGameOverUI() {
			// 1. å¡«å……æ•°æ®
			document.getElementById('go-score').innerText = Math.floor(score); // å½“å‰åˆ†æ•°
			document.getElementById('go-coins').innerText = coins;             // å½“å‰é‡‘å¸
			document.getElementById('go-dist').innerText = Math.floor(distance) + "m"; // è·ç¦»

			// 2. è·å–å¹¶æ˜¾ç¤ºæœ€é«˜åˆ† (ä»æœ¬åœ°å­˜å‚¨è¯»å–)
			let bestScore = localStorage.getItem('moonChaserBestScore') || 0;
			// å¦‚æœå½“å‰åˆ†æ›´é«˜ï¼Œæ›´æ–°å®ƒ
			if (score > bestScore) {
				bestScore = Math.floor(score);
				localStorage.setItem('moonChaserBestScore', bestScore);
			}
			document.getElementById('go-best').innerText = bestScore;

			// =========================================
			// ğŸ”¥ğŸ”¥ğŸ”¥ æ–°å¢ï¼šæ™ºèƒ½å¡«å……åå­— ğŸ”¥ğŸ”¥ğŸ”¥
			// =========================================
			// å°è¯•ä»æœ¬åœ°å­˜å‚¨è·å–ä¸Šæ¬¡çš„åå­—ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±é»˜è®¤å« "Runner"
			let lastName = localStorage.getItem('moonChaser_last_name') || "Runner";

			// èµ‹å€¼ç»™è¾“å…¥æ¡† (æ³¨æ„æ˜¯ .value ä¸æ˜¯ .placeholder)
			const nameInput = document.getElementById('new-name-input');
			nameInput.value = lastName;

			// 3. æ˜¾ç¤ºç•Œé¢
			document.getElementById('game-over-screen').style.display = 'block';

			// 4. ç¡®ä¿å…¶ä»–UIéšè— (HUDç­‰)
			document.getElementById('hud-panel').style.display = 'none';

			// 5. æ’­æ”¾ç»“æŸéŸ³æ•ˆ
			// AudioSystem.play('crash'); 
		}

		// è¾…åŠ©å‡½æ•°ï¼šè§¦å‘æ— æ•Œ
		function activateInvincibility() {
			hasShield = false; // æ¶ˆè€—æŠ¤ç›¾
			isInvincible = true;
			invincibleTimer = CONFIG.INVINCIBLE_DURATION;

			// æ’­æ”¾æŠ¤ç›¾ç ´ç¢éŸ³æ•ˆ (å€Ÿç”¨ä¸€ä¸‹æ’å‡»éŸ³æ•ˆï¼Œæˆ–è€…ä½ å¯ä»¥åŠ ä¸ªæ›´ç”µå­çš„å£°éŸ³)
			AudioSys.playTone(800, 'sawtooth', 0.1, 0.2);
			setTimeout(() => AudioSys.playTone(400, 'sawtooth', 0.3, 0.2), 100);

			// è§†è§‰æç¤ºï¼šä¹Ÿå¯ä»¥åœ¨è¿™é‡ŒåŠ ä¸ªè“è‰²çš„çˆ†ç‚¸åœˆ
			VFX.explode(player.position, 0x00FFFF, 1.5);
		}

		// è¾…åŠ©å‡½æ•°ï¼šæ’ç¢éšœç¢ç‰©
		function smashObstacle(obs, index) {
			// ç§»é™¤éšœç¢ç‰©
			scene.remove(obs);
			activeObstacles.splice(index, 1);

			// æ’­æ”¾ç‰¹æ•ˆ
			VFX.explode(obs.position, 0xE67E22, 1.0); // æ©™è‰²ç¢ç‰‡
			AudioSys.playSmash(false); // è½»æ’å‡»å£°
		}

		// æˆ‘ä»¬éœ€è¦åœ¨æ¯ä¸€å¸§æ£€æµ‹è¡Œé©¶ä¸­çš„ç«è½¦å‰æ–¹æ˜¯å¦æœ‰ä¸œè¥¿
		function checkTrainInteractions() {
			// ç­›é€‰å‡ºæ‰€æœ‰æ­£åœ¨è¡Œé©¶çš„ç«è½¦
			const movingTrains = activeObstacles.filter(o => o.userData.isMovingTrain && !o.userData.dead);

			movingTrains.forEach(train => {
				// åˆ›å»ºä¸€ä¸ªç¨å¾®æ¯”ç«è½¦å¤§ä¸€ç‚¹çš„åŒ…å›´ç›’ï¼Œç”¨äºæ£€æµ‹
				const trainBox = new THREE.Box3().setFromObject(train);
				// æ”¶ç¼©ä¸€ç‚¹ Z è½´ï¼Œé¿å…åˆšåˆšç”Ÿæˆæ—¶è¯¯åˆ¤ï¼Œåªæ£€æµ‹è½¦å¤´æ’å‡»
				trainBox.min.z += 1.0;
				trainBox.max.z -= 1.0;

				// éå†æ‰€æœ‰å…¶ä»–éšœç¢ç‰©
				for (let i = activeObstacles.length - 1; i >= 0; i--) {
					const target = activeObstacles[i];

					// è·³è¿‡è‡ªå·±ã€è·³è¿‡å·²ç»æ ‡è®°æ­»äº¡çš„ç‰©ä½“
					if (train === target || target.userData.dead) continue;

					const targetBox = new THREE.Box3().setFromObject(target);

					// å¦‚æœæ’ä¸Šäº†
					if (trainBox.intersectsBox(targetBox)) {

						// æƒ…å†µ 1: æ’åˆ°äº†é™æ­¢ç«è½¦ (æˆ–è€…å¦ä¸€è¾†ç§»åŠ¨ç«è½¦)
						if (target.userData.isObstacle && !target.userData.isHigh) { // isHighé€šå¸¸æ˜¯è·¯éšœæ¶å­ï¼Œè¿™é‡Œç²—ç•¥åˆ¤æ–­ä½“ç§¯å¤§çš„éšœç¢ç‰©

							// é€»è¾‘ï¼šè¡Œé©¶çš„ç«è½¦â€œå‘ç”Ÿäº‹æ•…â€æ¶ˆå¤±
							train.userData.dead = true;
							scene.remove(train); // ç§»é™¤è¡Œé©¶ç«è½¦

							// ç‰¹æ•ˆï¼šå¤§çˆ†ç‚¸ï¼Œé»‘è‰²ç¢ç‰‡ (æ¨¡æ‹Ÿé›¶ä»¶)
							VFX.explode(train.position, 0x111111, 2.0);
							AudioSys.playSmash(true); // é‡éŸ³æ•ˆ

							// æ—¢ç„¶ç«è½¦éƒ½æ²¡äº†ï¼Œå°±ä¸éœ€è¦æ£€æµ‹å®ƒæ’åˆ«çš„äº†ï¼Œç›´æ¥é€€å‡ºå½“å‰å¾ªç¯
							break;
						}

						// æƒ…å†µ 2: æ’åˆ°äº†å°éšœç¢ç‰© (æ æ†ã€è·¯éšœ)
						// æˆ–è€…æ˜¯é«˜æ¶è·¯éšœçš„æŸ±å­
						else {
							// é€»è¾‘ï¼šéšœç¢ç‰©è¢«ç¢¾ç¢
							target.userData.dead = true;
							scene.remove(target); // ç§»é™¤éšœç¢ç‰©
							activeObstacles.splice(i, 1); // ä»æ•°ç»„ä¸­ç§»é™¤

							// ç‰¹æ•ˆï¼šå°çˆ†ç‚¸ï¼Œç¢ç‰‡é¢œè‰²å–è‡ªéšœç¢ç‰©æœ¬èº«é¢œè‰² (æˆ–è€…æ˜¯é€šç”¨çš„æ©™è‰²/ç°è‰²)
							// ç®€å•çš„åšæ³•æ˜¯ç»™ä¸ªæ©™è‰²
							VFX.explode(target.position, 0xE67E22, 1.0);
							AudioSys.playSmash(false); // è½»éŸ³æ•ˆ
						}
					}
				}
			});

			// æ¸…ç†å·²æ ‡è®°æ­»äº¡çš„è¡Œé©¶ç«è½¦
			for (let i = activeObstacles.length - 1; i >= 0; i--) {
				if (activeObstacles[i].userData.dead) {
					activeObstacles.splice(i, 1);
				}
			}
		}

		function activateMagnet() {
			magnetActive = true; magnetTimer = CONFIG.MAGNET_DURATION;
			document.getElementById('magnet-status').classList.add('active');
			AudioSys.playPowerup();
		}
		function activateJetpack() {
			jetpackActive = true; jetpackTimer = CONFIG.JETPACK_DURATION;
			document.getElementById('jetpack-status').classList.add('active');
			AudioSys.playPowerup();
		}

		function collectCoin(coin) {
			if (coin.userData.collected) return;
			coin.userData.collected = true;

			// è·å–é‡‘å¸ä»·å€¼
			let value = coin.userData.value || 1;

			// å¦‚æœæ˜¯æ™®é€šé‡‘å¸ï¼Œåº”ç”¨é€Ÿåº¦å€ç‡å¥–åŠ±ï¼›å¦‚æœæ˜¯ç‰¹æ®Šé‡‘å¸ï¼Œç›´æ¥ç»™å›ºå®šé«˜é¢å¥–åŠ±
			if (coin.userData.type === 'normal') {
				const multiplier = 1 + Math.floor((speed - CONFIG.PLAYER_SPEED_BASE) / 5);
				value = value * multiplier;
				AudioSys.playCoin(); // æ™®é€šéŸ³æ•ˆ
			} else {
				// ç‰¹æ®Šé‡‘å¸éŸ³æ•ˆï¼šé¢‘ç‡æ›´é«˜ï¼ŒæŒç»­æ—¶é—´æ›´é•¿
				AudioSys.playTone(2000, 'square', 0.2, 0.2);
				setTimeout(() => AudioSys.playTone(3000, 'sine', 0.4, 0.2), 100);
			}

			coins += value;

			// å¯é€‰ï¼šåœ¨è¿™é‡Œæ·»åŠ ä¸€ä¸ªæµ®åŠ¨æ–‡å­—ç‰¹æ•ˆ "+50" (éœ€è¦é¢å¤–çš„DOMæ“ä½œï¼Œæš‚æ—¶ç•¥è¿‡ï¼ŒUIä¼šè‡ªåŠ¨è·³æ•°å­—)

			scene.remove(coin);
			activeCoins.splice(activeCoins.indexOf(coin), 1);
		}

		function updateWorldGen() {
			if (activeTracks[0].position.z > player.position.z + CONFIG.TRACK_LENGTH) {
				const seg = activeTracks.shift(); seg.position.z = activeTracks[activeTracks.length - 1].position.z - CONFIG.TRACK_LENGTH; activeTracks.push(seg);
			}
			if (world.lastSpawnZ > player.position.z - 80) { world.lastSpawnZ -= 25; spawnObstacle(world.lastSpawnZ); }
			const clean = (arr) => { for (let i = arr.length - 1; i >= 0; i--) { if (arr[i].position.z > player.position.z + 20) { scene.remove(arr[i]); arr.splice(i, 1); } } };
			clean(activeObstacles); clean(activeCoins); clean(activeMagnets); clean(activeJetpacks); clean(activeDecorations);
		}

		// --- V23: CHARACTER SYSTEM LOGIC ---
		const CharSys = {
			show: function (e) {
				if (e && e.stopPropagation) e.stopPropagation();
				this.render();
				// Hide Main Menu to prevent bugs
				document.getElementById('main-menu').classList.add('hidden');
				document.getElementById('char-screen').classList.remove('hidden');
			},
			close: function (e) {
				if (e && e.stopPropagation) e.stopPropagation();
				document.getElementById('char-screen').classList.add('hidden');
				document.getElementById('main-menu').classList.remove('hidden');
			},
			render: function () {
				const grid = document.getElementById('char-grid');
				grid.innerHTML = '';
				document.getElementById('char-coin-count').innerText = GameData.coins;
				document.getElementById('char-title').innerText = LANG[currentLang].charTitle;
				document.getElementById('char-close-btn').innerText = LANG[currentLang].charBack;

				for (const [id, data] of Object.entries(CHARACTERS)) {
					const isOwned = GameData.unlockedChars.includes(id);
					const isEquipped = GameData.curChar === id;

					let btnClass = isEquipped ? "buy-btn equipped" : (isOwned ? "buy-btn select" : "buy-btn");
					let btnText = isEquipped ? LANG[currentLang].equipped : (isOwned ? LANG[currentLang].equip : `${LANG[currentLang].buy} ${data.cost}`);
					// Use window.CharSys to ensure global access in onclick string
					let clickAction = isOwned ? `CharSys.equip('${id}')` : `CharSys.buy('${id}')`;

					grid.innerHTML += `
                <div class="store-item">
                    <div class="item-icon" style="color:#${new THREE.Color(data.color).getHexString()}">ğŸ¤–</div>
                    <div class="item-name">${data.name}</div>
                    <div class="item-desc">${isOwned ? LANG[currentLang].owned : ''}</div>
                    <button class="${btnClass}" onclick="${clickAction}">
                        ${!isOwned ? '<div class="css-coin" style="width:15px; height:15px;"></div>' : ''} ${btnText}
                    </button>
                </div>
            `;
				}
			},
			buy: function (id) {
				const char = CHARACTERS[id];
				if (GameData.coins >= char.cost) {
					GameData.coins -= char.cost;
					GameData.unlockedChars.push(id);
					GameData.curChar = id;
					GameData.save();
					AudioSys.playCoin();
					this.render();
					// Update player model in background immediately
					createPlayerModel();
				}
			},
			equip: function (id) {
				GameData.curChar = id;
				GameData.save();
				this.render();
				createPlayerModel();
			}
		};
		window.CharSys = CharSys;

		// --- GLOBAL BINDINGS ---
		const Store = {
			updateUI: function () {
				document.getElementById('store-coin-count').innerText = GameData.coins;
				document.getElementById('item-own-mag').innerText = LANG[currentLang].itemOwn + GameData.inventory.magnet;
				document.getElementById('buy-mag-btn').disabled = GameData.coins < CONFIG.COST_MAGNET;
				document.getElementById('check-mag').checked = GameData.settings.autoMagnet;
				document.getElementById('item-own-jet').innerText = LANG[currentLang].itemOwn + GameData.inventory.jetpack;
				document.getElementById('buy-jet-btn').disabled = GameData.coins < CONFIG.COST_JETPACK;
				document.getElementById('check-jet').checked = GameData.settings.autoJetpack;
			},
			buy: function (item) {
				if (item === 'magnet' && GameData.coins >= CONFIG.COST_MAGNET) {
					GameData.coins -= CONFIG.COST_MAGNET; GameData.inventory.magnet++;
					AudioSys.playCoin();
				}
				else if (item === 'jetpack' && GameData.coins >= CONFIG.COST_JETPACK) {
					GameData.coins -= CONFIG.COST_JETPACK; GameData.inventory.jetpack++;
					AudioSys.playCoin();
				}
				GameData.save(); this.updateUI(); updateHUD();
			},
			toggle: function (item) {
				if (item === 'magnet') GameData.settings.autoMagnet = document.getElementById('check-mag').checked;
				if (item === 'jetpack') GameData.settings.autoJetpack = document.getElementById('check-jet').checked;
				GameData.save();
			},
			show: function (e) {
				if (e && e.stopPropagation) e.stopPropagation();
				this.updateUI();
				document.getElementById('store-screen').classList.remove('hidden');
				document.getElementById('main-menu').classList.add('hidden');
			}
		};
		window.Store = Store;

		function closeStore(e) {
			if (e && e.stopPropagation) e.stopPropagation();
			document.getElementById('store-screen').classList.add('hidden');
			document.getElementById('main-menu').classList.remove('hidden');
		}
		window.closeStore = closeStore;

		function togglePause(e) {
			if (e && e.stopPropagation) e.stopPropagation();
			if (!gameActive) return;
			isPaused = !isPaused;

			if (isPaused) {
				document.getElementById('pause-screen').classList.remove('hidden');
				document.getElementById('pause-btn').classList.add('hidden');
				AudioSys.stopBGM();
			} else {
				document.getElementById('pause-screen').classList.add('hidden');
				document.getElementById('pause-btn').classList.remove('hidden');
				clock.getDelta();
				AudioSys.startBGM();
			}
		}
		window.togglePause = togglePause;

		function goHome(e) {
			if (e && e.stopPropagation) e.stopPropagation();
			gameActive = false;
			isPaused = false;
			AudioSys.stopBGM();

			// éšè—æ‰€æœ‰å¯èƒ½çš„ç•Œé¢
			document.getElementById('game-over').classList.add('hidden'); // æ—§ç‰ˆ
			document.getElementById('game-over-screen').style.display = 'none'; // ã€æ–°å¢è¿™ä¸€è¡Œï¼šéšè—æ–°ç‰ˆç»“ç®—ã€‘
			document.getElementById('pause-screen').classList.add('hidden');
			document.getElementById('pause-btn').classList.add('hidden');
			document.getElementById('hud-panel').classList.add('hidden');
			document.getElementById('main-menu').classList.remove('hidden');

			if (document.getElementById('menu-coin-count')) document.getElementById('menu-coin-count').innerText = GameData.coins;

			// Reset Camera
			camera.position.set(0, 4, 10);
			camera.rotation.set(-0.1, 0, 0);

			if (player) {
				player.position.set(0, 0, 0); player.rotation.set(0, 0, 0);
				if (player.userData.pack) player.userData.pack.visible = false;
				if (player.userData.flames) player.userData.flames.forEach(f => f.visible = false);
			}
			try {
				const cleanup = (arr) => { if (arr) { arr.forEach(o => scene.remove(o)); arr.length = 0; } };
				cleanup(activeObstacles); cleanup(activeCoins); cleanup(activeMagnets); cleanup(activeJetpacks); cleanup(activeDecorations);
				if (activeTracks) { activeTracks.forEach(t => scene.remove(t)); activeTracks.length = 0; for (let i = 0; i < 3; i++) createTrackSegment(-i * CONFIG.TRACK_LENGTH); }
				world.lastSpawnZ = 0;
			} catch (e) { console.warn("Cleanup warning:", e); }
		}
		window.goHome = goHome;

		// === æ–°å¢ï¼šä¿å­˜åˆ†æ•°å¹¶é‡å¼€çš„é€»è¾‘ ===
		function resetGame() {
			// 1. è·å–è¾“å…¥çš„åå­—ï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™é»˜è®¤å« "Runner"
			let playerName = document.getElementById('new-name-input').value.trim();
			if (!playerName) playerName = "Runner"; // é»˜è®¤åå­—

			// ğŸ”¥ğŸ”¥ğŸ”¥ æ–°å¢ï¼šè®°ä½è¿™ä¸ªåå­—ï¼Œä¸‹æ¬¡è‡ªåŠ¨å¡« ğŸ”¥ğŸ”¥ğŸ”¥
			localStorage.setItem('moonChaser_last_name', playerName);

			// 2. ä¿å­˜åˆ°æ’è¡Œæ¦œ (å¤ç”¨ä½ ç°æœ‰çš„ Leaderboard ç³»ç»Ÿ)
			Leaderboard.save(playerName, score, survivalTime);

			// 3. éšè—ç»“ç®—ç•Œé¢
			document.getElementById('game-over-screen').style.display = 'none';

			// 4. å¼€å§‹æ–°æ¸¸æˆ
			startGame();
		}

		// === æ–°å¢ï¼šä¿å­˜åˆ†æ•°å¹¶å›ä¸»èœå•çš„é€»è¾‘ ===
		function showMainMenu() {
			// 1. åŒæ ·ä¿å­˜åˆ†æ•°
			let playerName = document.getElementById('new-name-input').value.trim();
			if (!playerName) playerName = "Runner";

			// ğŸ”¥ğŸ”¥ğŸ”¥ æ–°å¢ï¼šè®°ä½è¿™ä¸ªåå­— ğŸ”¥ğŸ”¥ğŸ”¥
			localStorage.setItem('moonChaser_last_name', playerName);

			Leaderboard.save(playerName, score, survivalTime);

			// 2. éšè—ç»“ç®—ç•Œé¢
			document.getElementById('game-over-screen').style.display = 'none';

			// 3. è°ƒç”¨åŸæœ‰çš„å›ä¸»é¡µå‡½æ•°
			goHome();
		}

		const Leaderboard = {
			data: [], sortField: 'score', sortDesc: true, load: function () { this.data = JSON.parse(localStorage.getItem('moonChaser_ranks') || '[]') }, save: function (n, s, t) { this.load(); this.data.push({ name: n || "Guest", score: s, time: t }); localStorage.setItem('moonChaser_ranks', JSON.stringify(this.data)) },
			show: function (e) {
				if (e && e.stopPropagation) e.stopPropagation();
				this.load(); this.render(); document.getElementById('leaderboard-screen').classList.remove('hidden');
				document.getElementById('main-menu').classList.add('hidden');
			}, sort: function (f) { if (this.sortField === f) this.sortDesc = !this.sortDesc; else { this.sortField = f; this.sortDesc = true } this.render() }, render: function () { const b = document.getElementById('lb-body'); b.innerHTML = '';['name', 'score', 'time'].forEach(f => document.getElementById(`sort-${f}`).innerText = (this.sortField === f ? (this.sortDesc ? 'â–¼' : 'â–²') : '')); this.data.sort((a, c) => { let va = a[this.sortField], vb = c[this.sortField]; if (typeof va === 'string') { va = va.toLowerCase(); vb = vb.toLowerCase() } return (va < vb ? (this.sortDesc ? 1 : -1) : (va > vb ? (this.sortDesc ? -1 : 1) : 0)) }); const l = Math.min(10, this.data.length); if (l === 0) b.innerHTML = `<tr><td colspan="4" style="padding:20px;color:#999;">${LANG[currentLang].lbNoRecord}</td></tr>`; for (let i = 0; i < l; i++) { const d = this.data[i], m = Math.floor(d.time / 60).toString().padStart(2, '0'), s = Math.floor(d.time % 60).toString().padStart(2, '0'); const c = i === 0 ? '#FFD700' : (i === 1 ? '#C0C0C0' : (i === 2 ? '#CD7F32' : 'white')); b.innerHTML += `<tr><td style="color:${c}">#${i + 1}</td><td style="color:${c}">${d.name}</td><td>${d.score}</td><td>${m}:${s}</td></tr>` } }
		};
		window.Leaderboard = Leaderboard;

		document.getElementById('lb-close-btn').onclick = (e) => {
			if (e && e.stopPropagation) e.stopPropagation();
			document.getElementById('leaderboard-screen').classList.add('hidden');
			document.getElementById('main-menu').classList.remove('hidden');
		};

		function updateHUD() {
			// 1. æ›´æ–°åˆ†æ•°å’Œé‡‘å¸ (åŸæœ‰é€»è¾‘)
			document.getElementById('score-display').innerText = score.toString().padStart(6, '0');
			document.getElementById('coin-display').innerText = coins;

			const multiplier = 1 + Math.floor((speed - CONFIG.PLAYER_SPEED_BASE) / 5);
			const multElem = document.getElementById('coin-multiplier');
			if (multElem) {
				multElem.innerText = "x" + multiplier;
				multElem.style.color = multiplier > 5 ? '#FF0000' : (multiplier > 2 ? '#FFFF00' : '#00FFFF');
			}

			const speedVal = (speed / CONFIG.PLAYER_SPEED_BASE).toFixed(1);
			document.getElementById('speed-indicator').innerText = "SPEED: " + speedVal + "x";
			if (document.getElementById('menu-coin-count')) document.getElementById('menu-coin-count').innerText = GameData.coins;

			// --- 2. æ–°å¢ï¼šæŠ¤ç›¾ UI é€»è¾‘ ---
			const shieldBar = document.getElementById('shield-status');
			const shieldText = document.getElementById('shield-text');
			const scoreEl = document.getElementById('score-display'); // ç”¨äºæ§åˆ¶åˆ†æ•°é¢œè‰²åé¦ˆ

			if (isInvincible) {
				// çŠ¶æ€ï¼šæ— æ•Œå€’è®¡æ—¶ä¸­
				shieldBar.classList.add('active'); // ç¡®ä¿æ˜¾ç¤º
				shieldBar.classList.add('shield-flicker'); // UIæœ¬èº«ä¹Ÿè·Ÿç€é—ªçƒï¼Œå¢åŠ ç´§å¼ æ„Ÿ
				shieldText.innerText = invincibleTimer.toFixed(1) + "s";

				// åˆ†æ•°é¢œè‰²å˜çº¢/è“é—ªçƒ (å¯é€‰)
				scoreEl.style.color = '#00FFFF';
				scoreEl.style.textShadow = '0 0 15px #00FFFF';

			} else if (hasShield) {
				// çŠ¶æ€ï¼šæŠ¤ç›¾å°±ç»ª
				shieldBar.classList.add('active');
				shieldBar.classList.remove('shield-flicker'); // åœæ­¢é—ªçƒ
				shieldText.innerText = "READY"; // æˆ–è€… "ACTIVE"

				// åˆ†æ•°é¢œè‰²ï¼šé’è‰²å¸¸äº®
				scoreEl.style.color = '#1abc9c';
				scoreEl.style.textShadow = '0 0 5px #1abc9c';

			} else {
				// çŠ¶æ€ï¼šæ— æŠ¤ç›¾
				shieldBar.classList.remove('active');
				shieldBar.classList.remove('shield-flicker');

				// åˆ†æ•°é¢œè‰²ï¼šæ¢å¤ç™½è‰²
				scoreEl.style.color = 'white';
				scoreEl.style.textShadow = '3px 3px 0 #000';
			}
		}

		function gameOver() {
			gameActive = false;
			AudioSys.stopBGM();
			AudioSys.playCrash();

			// æ˜¾ç¤ºç»“ç®—ç•Œé¢
			showGameOverUI();

			document.getElementById('hud-panel').classList.add('hidden');
			document.getElementById('pause-btn').classList.add('hidden');
			//document.getElementById('game-over').classList.remove('hidden');
			document.getElementById('final-score-val').innerText = score;
			camera.lookAt(player.position);
			GameData.addCoins(coins);
		}

		function updateLocalization() {
			const t = LANG[currentLang];
			document.querySelector('#main-menu .game-title').innerHTML = t.title;
			document.getElementById('play-btn').innerText = t.play;
			document.getElementById('rank-btn').innerText = t.rankBtn;
			document.getElementById('controls-hint').innerHTML = t.controls;
			document.querySelector('#game-over .game-title').innerText = t.crashed;
			document.querySelector('#final-score-box div:first-child').innerText = t.score;
			document.getElementById('restart-btn').innerText = t.lbSave;
			document.getElementById('home-btn').innerText = t.mainMenu;
			document.getElementById('name-input').placeholder = t.lbPlaceholder;
			document.getElementById('lb-title-text').innerText = t.lbTitle;
			document.getElementById('th-rank').innerText = t.lbRank;
			document.getElementById('th-name').firstChild.textContent = t.lbName + " ";
			document.getElementById('th-score').firstChild.textContent = t.lbScore + " ";
			document.getElementById('th-time').firstChild.textContent = t.lbTime + " ";
			document.getElementById('lb-close-btn').innerText = t.lbClose;
			document.getElementById('store-btn').innerText = t.storeBtn;
			document.querySelector('.store-header .game-title').innerText = t.storeTitle;
			document.getElementById('store-close-btn').innerText = t.storeBack;
			document.getElementById('item-name-mag').innerText = t.itemNameMag;
			document.getElementById('item-desc-mag').innerText = t.itemDescMag;
			document.getElementById('auto-use-mag').innerText = t.autoUse;
			document.getElementById('item-name-jet').innerText = t.itemNameJet;
			document.getElementById('item-desc-jet').innerText = t.itemDescJet;
			document.getElementById('auto-use-jet').innerText = t.autoUse;
			document.getElementById('pause-title').innerText = t.pauseTitle;
			document.getElementById('resume-btn').innerText = t.resume;
			document.getElementById('pause-home-btn').innerText = t.pauseMenu;

			document.getElementById('new-name-input').placeholder = t.lbPlaceholder; // å¤ç”¨åŸæœ¬çš„ "è¾“å…¥åå­—" ç¿»è¯‘
			document.querySelector('.go-title').innerText = t.crashed; // æŠŠ GAME OVER æ”¹æˆä¸­æ–‡

			// V23: Char Screen Loc
			document.getElementById('char-btn').innerText = t.charTitle;
			if (!document.getElementById('leaderboard-screen').classList.contains('hidden')) Leaderboard.render();
			if (!document.getElementById('store-screen').classList.contains('hidden')) Store.updateUI();
			if (!document.getElementById('char-screen').classList.contains('hidden')) CharSys.render();
		}

		function setupInputs() {
			document.addEventListener('keydown', e => {
				if (isPaused) return;
				if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight", " "].includes(e.key)) e.preventDefault();
				if (!gameActive) return;
				if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') { if (targetLane > 0) targetLane--; }
				if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') { if (targetLane < 2) targetLane++; }
				if (e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W' || e.key === ' ') { if (!isJumping && !jetpackActive) { isJumping = true; verticalVelocity = CONFIG.JUMP_FORCE; isSliding = false; player.scale.y = 1; } }
				if (e.key === 'ArrowDown' || e.key === 's' || e.key === 'S') { if (!isJumping && !jetpackActive) { isSliding = true; slideTimer = 0.8; verticalVelocity = -0.5; } }
				if (e.key === 'Escape') togglePause();
			});

			let tx = 0, ty = 0;
			document.addEventListener('touchstart', e => { tx = e.changedTouches[0].screenX; ty = e.changedTouches[0].screenY; }, { passive: false });
			document.addEventListener('touchmove', e => { if (gameActive) e.preventDefault(); }, { passive: false });
			document.addEventListener('touchend', e => {
				if (!gameActive || isPaused) return;
				const dx = e.changedTouches[0].screenX - tx, dy = e.changedTouches[0].screenY - ty;
				if (Math.abs(dx) > Math.abs(dy)) { if (Math.abs(dx) > 30) dx > 0 ? (targetLane < 2 && targetLane++) : (targetLane > 0 && targetLane--); }
				else { if (Math.abs(dy) > 30) dy < 0 ? (!isJumping && !jetpackActive && (isJumping = true, verticalVelocity = CONFIG.JUMP_FORCE, isSliding = false, player.scale.y = 1)) : (!jetpackActive && (isSliding = true, slideTimer = 0.8, verticalVelocity = -0.5)); }
			});
		}

		function setupUI() {
			document.getElementById('restart-btn').onclick = () => { Leaderboard.save(document.getElementById('name-input').value.trim(), score, survivalTime); startGame(); };
			document.getElementById('lang-btn').onclick = () => { currentLang = currentLang === 'en' ? 'cn' : 'en'; updateLocalization(); };
			updateLocalization();
		}

		init();
	</script>
</body>

</html>